<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Publiery</title>
    <!-- Prevenir cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Verificaci√≥n de autenticaci√≥n antes de cargar el panel -->
    <script>
        // Funci√≥n fetch personalizada que incluye credenciales autom√°ticamente
        const apiRequest = async (url, options = {}) => {
            const defaultOptions = {
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            };
            
            return fetch(url, { ...defaultOptions, ...options });
        };
        
        // Verificar autenticaci√≥n inmediatamente
        async function verificarAutenticacion() {
            try {
                // Obtener par√°metros de la URL
                const urlParams = new URLSearchParams(window.location.search);
                const testParam = urlParams.get('test');
                
                let url = 'api/auth/admin-auth-unified.php?action=check';
                if (testParam) url += `&test=${testParam}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.authenticated) {
                    // Si no est√° autenticado, redirigir al login de forma simple
                    console.log('‚ùå Usuario no autenticado, redirigiendo al login...');
                    
                    setTimeout(() => {
                        window.location.href = 'admin-login.html';
                    }, 2000);
                    
                    return false;
                }
                
                console.log('‚úÖ Usuario autenticado como admin:', data.user.nombre, '(M√©todo:', data.method + ')');
                
                // MOSTRAR EL CONTENIDO DEL PANEL SOLO DESPU√âS DE AUTENTICACI√ìN EXITOSA
                hideLoadingScreen();
                showAdminPanel();
                
                // Mostrar informaci√≥n del usuario en el panel
                if (data.user && data.user.nombre) {
                    const userInfo = document.getElementById('admin-user-info');
                    if (userInfo) {
                        userInfo.textContent = data.user.nombre;
                    }
                }
                
                return true;
            } catch (error) {
                console.error('‚ùå Error verificando autenticaci√≥n:', error);
                
                setTimeout(() => {
                    window.location.href = 'admin-login.html';
                }, 3000);
                
                return false;
            }
        }
        
        // Funci√≥n de logout mejorada
        async function cerrarSesion() {
            if (!confirm('¬øSeguro que deseas cerrar sesi√≥n?')) return;
            
            console.log('üö™ Iniciando cierre de sesi√≥n...');
            
            try {
                // Limpiar storage local
                localStorage.clear();
                sessionStorage.clear();
                
                // Llamar al API de logout
                const response = await fetch('api/auth/logout.php', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin' // Incluir cookies de sesi√≥n
                });
                
                const data = await response.json();
                console.log('‚úÖ Respuesta logout:', data);
                
                if (data.success) {
                    console.log('‚úÖ Sesi√≥n cerrada correctamente');
                } else {
                    console.warn('‚ö†Ô∏è Error en logout pero continuando:', data.error);
                }
                
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n logout:', error);
                // Continuar aunque haya error
            }
            
            // SIEMPRE redirigir al login
            console.log('üîÑ Redirigiendo al login...');
            window.location.replace('admin-login.html'); // replace previene ir "atr√°s"
        }
        
        // Funciones para mostrar/ocultar el panel
        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('auth-loading');
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
        }
        
        function showAdminPanel() {
            const panelContent = document.getElementById('admin-panel-content');
            if (panelContent) {
                panelContent.style.display = 'block';
            }
        }
        
        function showAuthError(message) {
            hideLoadingScreen();
            
            // Definir la funci√≥n limpiarAuth globalmente
            window.limpiarAuth = async function() {
                try {
                    await fetch('api/auth/admin-auth-unified.php?action=clear');
                    localStorage.clear();
                    sessionStorage.clear();
                    alert('‚úÖ Autenticaci√≥n limpiada. Recarga la p√°gina.');
                    location.reload();
                } catch(e) {
                    alert('Error al limpiar: ' + e.message);
                }
            };
            
            document.body.innerHTML = `
                <div style="text-align:center; padding:50px; font-family:Arial; background-color:#2c3e50; color:white; min-height:100vh; display:flex; align-items:center; justify-content:center;">
                    <div style="background:white; color:#333; padding:40px; border-radius:10px; max-width:500px; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
                        <h2 style="color:#e74c3c; margin-bottom:20px;">üîí Acceso Restringido</h2>
                        <p style="margin-bottom:30px;">${message}</p>
                        <div style="margin:20px 0;">
                            <button onclick="limpiarAuth()" style="background:#dc3545; color:white; padding:12px 24px; border:none; border-radius:5px; margin:8px; cursor:pointer; font-size:14px;">
                                üóëÔ∏è Limpiar Autenticaci√≥n
                            </button>
                            <button onclick="location.href='admin-login.html'" style="background:#007bff; color:white; padding:12px 24px; border:none; border-radius:5px; margin:8px; cursor:pointer; font-size:14px;">
                                üîë Ir a Login
                            </button>
                            <button onclick="location.href='admin-panel.html?test=admin'" style="background:#28a745; color:white; padding:12px 24px; border:none; border-radius:5px; margin:8px; cursor:pointer; font-size:14px;">
                                üß™ Modo Testing
                            </button>
                        </div>
                        <small style="color:#666;">üí° Si siempre necesitas borrar historial, usa "Limpiar Autenticaci√≥n"</small>
                    </div>
                </div>
            `;
        }
        
        // Ejecutar verificaci√≥n una sola vez cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Panel de administraci√≥n iniciado');
            verificarAutenticacion();
        });
        
        // Tambi√©n ejecutar si el DOM ya est√° listo
        if (document.readyState !== 'loading') {
            console.log('üöÄ Panel de administraci√≥n iniciado');
            verificarAutenticacion();
        }
    </script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --dark-color: #34495e;
            --light-color: #ecf0f1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
        }

        .sidebar {
            width: 250px;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
            position: fixed;
            left: 0;
            top: 0;
            color: white;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 1.5rem;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
        }

        .nav-item {
            margin: 0.25rem 0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .nav-link:hover,
        .nav-link.active {
            background-color: rgba(255,255,255,0.1);
            color: white;
            border-left-color: var(--secondary-color);
        }

        .nav-link i {
            width: 20px;
            margin-right: 0.75rem;
        }

        .main-content {
            margin-left: 250px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .topbar {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: between;
            align-items: center;
            border-bottom: 1px solid #e9ecef;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0;
        }

        .content-area {
            padding: 2rem;
        }

        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid var(--secondary-color);
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-2px);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-top: 1rem;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }

        /* Botones de acci√≥n mejorados */
        .btn {
            transition: all 0.2s ease;
            border-radius: 6px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            min-width: 2.5rem;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #d97706, #b45309);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
        }

        /* Estados de loading para botones */
        .btn.loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .btn.loading::after {
            content: '';
            width: 12px;
            height: 12px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mejorar estilos de tabla */
        .table-hover tbody tr:hover {
            background-color: rgba(59, 130, 246, 0.05);
            transition: all 0.2s ease;
        }

        .search-box {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-box input {
            padding-left: 2.5rem;
        }

        .search-box i {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
        }

        .badge-status {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-activo { background-color: #d4edda; color: #155724; }
        .status-inactivo { background-color: #f8d7da; color: #721c24; }
        .status-pendiente { background-color: #fff3cd; color: #856404; }

        .priority-alta { background-color: #f8d7da; color: #721c24; }
        .priority-media { background-color: #fff3cd; color: #856404; }
        .priority-baja { background-color: #d4edda; color: #155724; }
        .priority-critica { background-color: #d1ecf1; color: #0c5460; }

        /* === ESTILOS MEJORADOS PARA RESUMEN GENERAL === */
        .dashboard-section {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .dashboard-title {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 2rem;
            font-size: 2rem;
        }

        .section-title {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 0.5rem;
        }

        .ranking-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 4px solid var(--secondary-color);
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .ranking-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .alertas-gestion {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #ffc107;
        }

        .alerta-item {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .alerta-item:hover {
            background-color: #e9ecef;
            transform: translateX(5px);
        }

        .actividad-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #17a2b8;
        }

        .actividad-item {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .actividad-item:hover {
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .actividad-item:last-child {
            border-bottom: none;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ranking-number {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .ranking-label {
            font-size: 0.8rem;
            color: #6c757d;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-custom {
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .refresh-btn {
            background: var(--secondary-color);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: #2980b9;
            transform: scale(1.05);
        }

        .text-gradient {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* === ESTILOS PARA MODALES DE INFORMACI√ìN === */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1050;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: between;
            align-items: center;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .modal-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .modal-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .info-section {
            margin-bottom: 1.5rem;
        }

        .info-section:last-child {
            margin-bottom: 0;
        }

        .info-section h6 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 0.75rem;
            font-size: 1rem;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 0.25rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 500;
            color: #6c757d;
            min-width: 120px;
        }

        .info-value {
            font-weight: 600;
            color: var(--primary-color);
            text-align: right;
            flex: 1;
        }

        .badge-modal {
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-activo {
            background-color: #d4edda;
            color: #155724;
        }

        .badge-inactivo {
            background-color: #f8d7da;
            color: #721c24;
        }

        .badge-pendiente {
            background-color: #fff3cd;
            color: #856404;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="auth-loading" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #2c3e50; color: white; display: flex; align-items: center; justify-content: center; z-index: 9999; font-family: Arial;">
        <div style="text-align: center;">
            <div style="border: 4px solid #3498db; border-top: 4px solid transparent; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
            <h3>üîí Verificando Autenticaci√≥n...</h3>
            <p>Por favor espera mientras validamos tu sesi√≥n</p>
        </div>
    </div>
    
    <!-- Panel Content (hidden by default) -->
    <div id="admin-panel-content" style="display: none;">
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-book"></i> Publiery Admin</h3>
        </div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="#" class="nav-link active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Resumen General
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('usuarios')">
                    <i class="fas fa-users"></i> Usuarios
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('afiliados')">
                    <i class="fas fa-handshake"></i> Afiliados
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('escritores')">
                    <i class="fas fa-pen-nib"></i> Escritores
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('libros')">
                    <i class="fas fa-book-open"></i> Libros
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('revision')">
                    <i class="fas fa-search"></i> Revisi√≥n
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('archivados')">
                    <i class="fas fa-archive"></i> Archivados
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('ventas')">
                    <i class="fas fa-shopping-cart"></i> Ventas
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('pagos')">
                    <i class="fas fa-dollar-sign"></i> Pagos
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('campanas')">
                    <i class="fas fa-bullhorn"></i> Campa√±as
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('notificaciones')">
                    <i class="fas fa-bell"></i> Notificaciones
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('testimonios')">
                    <i class="fas fa-star"></i> Testimonios
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('estadisticas')">
                    <i class="fas fa-chart-bar"></i> Estad√≠sticas
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('configuracion')">
                    <i class="fas fa-cog"></i> Configuraci√≥n
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showSection('soporte')">
                    <i class="fas fa-life-ring"></i> Soporte
                </a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Topbar -->
        <div class="topbar">
            <h1 class="page-title" id="pageTitle">Resumen General</h1>
            <div>
                <button class="btn btn-outline-primary me-2">
                    <i class="fas fa-user"></i> <span id="admin-user-info">Admin</span>
                </button>
                <button class="btn btn-outline-danger" onclick="cerrarSesion()">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Resumen General Section -->
            <div id="dashboard" class="section active dashboard-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="dashboard-title"><i class="fas fa-tachometer-alt"></i> Resumen General</h1>
                    <button class="refresh-btn" onclick="cargarDashboardCompleto()" title="Actualizar estad√≠sticas">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="stats-card">
                            <h5><i class="fas fa-users text-primary"></i> Usuarios</h5>
                            <h3 class="text-primary" id="total-usuarios">4</h3>
                            <small class="text-muted">Total registrados</small>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="stats-card">
                            <h5><i class="fas fa-book text-success"></i> Libros</h5>
                            <h3 class="text-success" id="total-libros">1</h3>
                            <small class="text-muted">Publicados</small>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="stats-card">
                            <h5><i class="fas fa-bullhorn text-warning"></i> Campa√±as</h5>
                            <h3 class="text-warning" id="total-campanas">0</h3>
                            <small class="text-muted">Activas</small>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="stats-card">
                            <h5><i class="fas fa-dollar-sign text-info"></i> Ventas</h5>
                            <h3 class="text-info" id="total-ventas">$0</h3>
                            <small class="text-muted">Este mes</small>
                        </div>
                    </div>
                </div>
                
                <!-- Segunda fila: Rankings y Top Performers -->
                <div class="row">
                    <div class="col-12 mb-4">
                        <h2 class="section-title"><i class="fas fa-trophy"></i> Rankings y Top Performers</h2>
                        <div class="row" id="rankings-content">
                            <div class="text-center py-3">
                                <i class="fas fa-spinner fa-spin text-primary"></i> 
                                <p class="text-muted mt-2">Cargando rankings...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tercera fila: Alertas Mejoradas -->
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="alertas-gestion">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2 class="section-title mb-0" style="border-bottom: none; padding-bottom: 0;">
                                    <i class="fas fa-exclamation-triangle text-warning"></i> Alertas de Gesti√≥n
                                </h2>
                                <button class="refresh-btn btn-sm" onclick="cargarAlertas()" title="Actualizar alertas">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div id="alertas-content" style="max-height: 300px; overflow-y: auto;">
                                <div class="text-center py-3">
                                    <i class="fas fa-spinner fa-spin text-warning"></i>
                                    <p class="text-muted mt-2">Cargando alertas...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    
                <!-- Cuarta fila: Actividad Reciente -->
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="actividad-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2 class="section-title mb-0" style="border-bottom: none; padding-bottom: 0;">
                                    <i class="fas fa-history text-info"></i> Actividad Reciente (√öltimos 7 d√≠as)
                                </h2>
                                <button class="refresh-btn btn-sm" onclick="refrescarActividad()" title="Actualizar actividad">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div id="actividad-content" style="max-height: 400px; overflow-y: auto;">
                                <div class="text-center py-3">
                                    <i class="fas fa-spinner fa-spin text-info"></i> 
                                    <p class="text-muted mt-2">Cargando actividad...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Usuarios Section -->
            <div id="usuarios" class="section">
                <div class="table-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="fas fa-users"></i> Gesti√≥n de Usuarios</h4>
                        <button class="btn btn-primary" onclick="crearUsuario()">
                            <i class="fas fa-plus"></i> Nuevo Usuario
                        </button>
                    </div>
                    
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" class="form-control" placeholder="Buscar usuarios..." id="searchUsuarios" onkeyup="filtrarUsuarios()">
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Rol</th>
                                    <th>Estado</th>
                                    <th>Fecha Registro</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaUsuarios">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <i class="fas fa-spinner fa-spin"></i> Cargando usuarios...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Afiliados Section -->
            <div id="afiliados" class="section">
                <div class="table-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="fas fa-handshake"></i> Gesti√≥n de Afiliados</h4>
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> Para crear nuevos afiliados, usa la pesta√±a "Usuarios"
                        </small>
                    </div>
                    
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" class="form-control" placeholder="Buscar afiliados..." id="searchAfiliados" onkeyup="filtrarAfiliados()">
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>C√≥digo Afiliado</th>
                                    <th>Comisi√≥n</th>
                                    <th>Ventas</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaAfiliados">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <i class="fas fa-spinner fa-spin"></i> Cargando afiliados...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Escritores Section -->
            <div id="escritores" class="section">
                <div class="table-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="fas fa-pen-nib"></i> Gesti√≥n de Escritores</h4>
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> Para crear nuevos escritores, usa la pesta√±a "Usuarios"
                        </small>
                    </div>
                    
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" class="form-control" placeholder="Buscar escritores..." id="searchEscritores" onkeyup="filtrarEscritores()">
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Libros</th>
                                    <th>Royalties</th>
                                    <th>Estado</th>
                                    <th>Fecha Registro</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaEscritores">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <i class="fas fa-spinner fa-spin"></i> Cargando escritores...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Libros Section -->
            <div id="libros" class="section">
                <div class="table-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="fas fa-book-open"></i> Gesti√≥n de Libros</h4>
                        <button class="btn btn-primary" onclick="crearLibro()">
                            <i class="fas fa-plus"></i> Nuevo Libro
                        </button>
                    </div>
                    
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" class="form-control" placeholder="Buscar libros..." id="searchLibros" onkeyup="filtrarLibros()">
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>T√≠tulo</th>
                                    <th>Autor</th>
                                    <th>Categor√≠a</th>
                                    <th>Precio Regular</th>
                                    <th>Precio Afiliado</th>
                                    <th>Estado</th>
                                    <th>Ventas</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaLibros">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <i class="fas fa-spinner fa-spin"></i> Cargando libros...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Revisi√≥n Section -->
            <div id="revision" class="section">
                <div class="table-container">
                    <h4><i class="fas fa-search"></i> Revisi√≥n de Libros</h4>
                    <p>Libros pendientes de revisi√≥n administrativa</p>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>T√≠tulo</th>
                                    <th>Autor</th>
                                    <th>Fecha Env√≠o</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaRevision">
                                <tr>
                                    <td colspan="6" class="text-center">
                                        <i class="fas fa-spinner fa-spin"></i> Cargando libros para revisi√≥n...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Libros Archivados Section -->
            <div id="archivados" class="section">
                <div class="table-container">
                    <h4><i class="fas fa-archive"></i> Libros Archivados</h4>
                    <p>Libros que han sido archivados - Se pueden restaurar cuando sea necesario</p>
                    
                    <div class="search-box mb-3">
                        <i class="fas fa-search"></i>
                        <input type="text" class="form-control" placeholder="Buscar libros archivados..." id="searchArchivados" onkeyup="filtrarArchivados()">
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>T√≠tulo</th>
                                    <th>Autor</th>
                                    <th>Categor√≠a</th>
                                    <th>Fecha Archivado</th>
                                    <th>Estado Anterior</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaArchivados">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <i class="fas fa-spinner fa-spin"></i> Cargando libros archivados...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Ventas Section -->
            <div id="ventas" class="section">
                <div class="table-container">
                    <h4><i class="fas fa-shopping-cart"></i> Gesti√≥n de Ventas</h4>
                    
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="stats-card">
                                <h6>Ventas Hoy</h6>
                                <h4 class="text-success" id="ventas-hoy">$0</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card">
                                <h6>Ventas Mes</h6>
                                <h4 class="text-primary" id="ventas-mes">$0</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card">
                                <h6>Libros Vendidos</h6>
                                <h4 class="text-warning" id="libros-vendidos">0</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card">
                                <h6>Comisiones</h6>
                                <h4 class="text-info" id="comisiones-total">$0</h4>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID Venta</th>
                                    <th>Libro</th>
                                    <th>Cliente</th>
                                    <th>Afiliado</th>
                                    <th>Precio</th>
                                    <th>Comisi√≥n</th>
                                    <th>Fecha</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="tablaVentas">
                                <tr><td colspan="8" class="text-center">Cargando ventas...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pagos Section -->
            <div id="pagos" class="section">
                <div class="table-container">
                    <h4><i class="fas fa-dollar-sign"></i> Gesti√≥n de Pagos y Royalties</h4>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Beneficiario</th>
                                    <th>Tipo</th>
                                    <th>Monto</th>
                                    <th>Per√≠odo</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaPagos">
                                <tr><td colspan="8" class="text-center">Cargando pagos...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Testimonios Section -->
            <div id="testimonios" class="section">
                <div class="table-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="fas fa-star"></i> Gesti√≥n de Testimonios</h4>
                        <button class="btn btn-primary" onclick="crearTestimonio()">
                            <i class="fas fa-plus"></i> Nuevo Testimonio
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Cliente</th>
                                    <th>Libro</th>
                                    <th>Calificaci√≥n</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaTestimonios">
                                <tr><td colspan="7" class="text-center">Cargando testimonios...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Estad√≠sticas Section -->
            <div id="estadisticas" class="section">
                <div class="table-container">
                    <h4><i class="fas fa-chart-bar"></i> Estad√≠sticas Avanzadas</h4>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="ventasChart" width="400" height="200"></canvas>
                        </div>
                        <div class="col-md-6">
                            <canvas id="usuariosChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuraci√≥n Section -->
            <div id="configuracion" class="section">
                <div class="table-container">
                    <h4><i class="fas fa-cog"></i> Configuraci√≥n del Sistema</h4>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Configuraci√≥n General</h5>
                            <form>
                                <div class="mb-3">
                                    <label class="form-label">Nombre del Sitio</label>
                                    <input type="text" class="form-control" value="Publiery">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email Administrativo</label>
                                    <input type="email" class="form-control" value="admin@publiery.com">
                                </div>
                                <button type="submit" class="btn btn-primary">Guardar</button>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <h5>Configuraci√≥n de Comisiones</h5>
                            <form>
                                <div class="mb-3">
                                    <label class="form-label">Comisi√≥n Afiliados (%)</label>
                                    <input type="number" class="form-control" value="15">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Royalties Escritores (%)</label>
                                    <input type="number" class="form-control" value="70">
                                </div>
                                <button type="submit" class="btn btn-primary">Guardar</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Soporte Section -->
            <div id="soporte" class="section">
                <div class="table-container">
                    <h4><i class="fas fa-life-ring"></i> Tickets de Soporte</h4>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Usuario</th>
                                    <th>Asunto</th>
                                    <th>Prioridad</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaSoporte">
                                <tr><td colspan="7" class="text-center">Cargando tickets...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Campa√±as Section -->
            <div id="campanas" class="section">
                <div class="table-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="fas fa-bullhorn"></i> Gesti√≥n de Campa√±as</h4>
                        <button class="btn btn-primary" onclick="crearCampana()">
                            <i class="fas fa-plus"></i> Nueva Campa√±a
                        </button>
                    </div>
                    
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" class="form-control" placeholder="Buscar campa√±as..." id="searchCampanas" onkeyup="filtrarCampanas()">
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Tipo</th>
                                    <th>Estado</th>
                                    <th>Fecha Inicio</th>
                                    <th>ROI</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaCampanas">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <i class="fas fa-spinner fa-spin"></i> Cargando campa√±as...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Notificaciones Section -->
            <div id="notificaciones" class="section">
                <div class="table-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="fas fa-bell"></i> Gesti√≥n de Notificaciones</h4>
                        <button class="btn btn-primary" onclick="crearNotificacion()">
                            <i class="fas fa-plus"></i> Nueva Notificaci√≥n
                        </button>
                    </div>
                    
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" class="form-control" placeholder="Buscar notificaciones..." id="searchNotificaciones" onkeyup="filtrarNotificaciones()">
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>T√≠tulo</th>
                                    <th>Tipo</th>
                                    <th>Prioridad</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaNotificaciones">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <i class="fas fa-spinner fa-spin"></i> Cargando notificaciones...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Libros Section -->
            <div id="libros" class="section">
                <div class="table-container">
                    <h4>Gesti√≥n de Libros</h4>
                    <p>Pr√≥ximamente...</p>
                </div>
            </div>

            <!-- Afiliados Section -->
            <div id="afiliados" class="section">
                <div class="table-container">
                    <h4>Gesti√≥n de Afiliados</h4>
                    <p>Pr√≥ximamente...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        console.log('üöÄ Iniciando Panel de Administraci√≥n Limpio...');

        // === FUNCIONES DE NAVEGACI√ìN ===
        function showSection(sectionName) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar la secci√≥n seleccionada
            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Actualizar men√∫
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Actualizar t√≠tulo
            const titles = {
                'dashboard': 'Resumen General',
                'usuarios': 'Usuarios',
                'afiliados': 'Afiliados',
                'escritores': 'Escritores',
                'libros': 'Libros',
                'revision': 'Revisi√≥n de Libros',
                'ventas': 'Ventas',
                'pagos': 'Pagos y Royalties',
                'campanas': 'Campa√±as',
                'notificaciones': 'Notificaciones',
                'testimonios': 'Testimonios',
                'estadisticas': 'Estad√≠sticas',
                'configuracion': 'Configuraci√≥n',
                'soporte': 'Soporte'
            };
            document.getElementById('pageTitle').textContent = titles[sectionName] || 'Panel Admin';
            
            // Cargar datos espec√≠ficos de la secci√≥n
            if (sectionName === 'campanas') {
                cargarCampanas();
            } else if (sectionName === 'notificaciones') {
                cargarNotificaciones();
            } else if (sectionName === 'usuarios') {
                cargarUsuarios();
            } else if (sectionName === 'afiliados') {
                cargarAfiliados();
            } else if (sectionName === 'escritores') {
                cargarEscritores();
            } else if (sectionName === 'libros') {
                cargarLibros();
            } else if (sectionName === 'revision') {
                cargarRevision();
            } else if (sectionName === 'archivados') {
                cargarArchivados();
            } else if (sectionName === 'ventas') {
                cargarVentas();
            } else if (sectionName === 'pagos') {
                cargarPagos();
            } else if (sectionName === 'testimonios') {
                cargarTestimonios();
            } else if (sectionName === 'soporte') {
                cargarSoporte();
            }
        }

        function logout() {
            if (confirm('¬øSeguro que deseas cerrar sesi√≥n?')) {
                window.location.href = 'admin-login.html';
            }
        }

        // === FUNCIONES DE CAMPA√ëAS ===
        console.log('üîß Cargando funciones de campa√±as...');
        
        window.verCampana = async function(id) {
            console.log('‚úÖ verCampana llamada con ID:', id);
            try {
                let res = await fetch(`api/campanas/obtener_robusto.php?id=${id}`);
                let data = await res.json();
                
                if (data.success && data.campana) {
                    const campana = data.campana;
                    const modalContent = `
                        <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center;" onclick="this.remove()">
                            <div style="background:white;padding:2rem;border-radius:8px;max-width:600px;max-height:80vh;overflow:auto;" onclick="event.stopPropagation()">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                                    <h3>Campa√±a #${campana.id}</h3>
                                    <button onclick="this.closest('div[style*=\"position:fixed\"]').remove()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;">&times;</button>
                                </div>
                                <div style="margin-bottom:1rem;">
                                    <strong>Nombre:</strong> ${campana.nombre}<br>
                                    <strong>Tipo:</strong> ${campana.tipo}<br>
                                    <strong>Estado:</strong> ${campana.estado}<br>
                                    <strong>Fecha Inicio:</strong> ${new Date(campana.fecha_inicio).toLocaleString()}<br>
                                    <strong>Presupuesto:</strong> $${campana.presupuesto}<br>
                                    <strong>ROI:</strong> ${campana.roi}%<br>
                                </div>
                                <div style="margin-bottom:1rem;">
                                    <strong>Descripci√≥n:</strong><br>
                                    <div style="background:#f8f9fa;padding:1rem;border-radius:4px;">${campana.descripcion}</div>
                                </div>
                                <div style="display:flex;gap:0.5rem;justify-content:flex-end;">
                                    <button onclick="window.duplicarCampana(${campana.id})" class="btn btn-primary">Duplicar</button>
                                    <button onclick="window.activarCampana(${campana.id})" class="btn btn-success">Activar</button>
                                    <button onclick="window.eliminarCampana(${campana.id})" class="btn btn-danger">Eliminar</button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', modalContent);
                } else {
                    alert('Error: ' + (data.error || 'Campa√±a no encontrada'));
                }
            } catch (err) {
                console.error('‚ùå Error:', err);
                alert('Error de conexi√≥n: ' + err.message);
            }
        };

        window.duplicarCampana = async function(id) {
            console.log('‚úÖ duplicarCampana llamada con ID:', id);
            if (!confirm('¬øDeseas duplicar esta campa√±a?')) {
                console.log('‚ö†Ô∏è Usuario cancel√≥ la duplicaci√≥n');
                return;
            }
            
            try {
                console.log('üì° Enviando petici√≥n de duplicar...');
                const res = await fetch('api/campanas/actualizar_robusto.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, accion: 'duplicar' })
                });
                const data = await res.json();
                console.log('üìÑ Respuesta duplicar:', data);
                
                if (data.success) {
                    alert('‚úÖ Campa√±a duplicada correctamente');
                    console.log('üîÑ Recargando campa√±as...');
                    cargarCampanas(); // Recargar tabla
                    // Cerrar modal si est√° abierto
                    const modal = document.querySelector('div[style*="position:fixed"]');
                    if (modal) modal.remove();
                } else {
                    console.error('‚ùå Error en respuesta:', data.error);
                    alert('‚ùå Error: ' + (data.message || data.error || 'No se pudo duplicar la campa√±a'));
                }
            } catch (err) {
                console.error('‚ùå Error de conexi√≥n:', err);
                alert('Error de conexi√≥n: ' + err.message);
            }
        };

        window.activarCampana = async function(id) {
            console.log('‚úÖ activarCampana llamada con ID:', id);
            
            try {
                console.log('üì° Enviando petici√≥n de activar...');
                const res = await fetch('api/campanas/actualizar_robusto.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, accion: 'activar' })
                });
                const data = await res.json();
                console.log('üìÑ Respuesta activar:', data);
                
                if (data.success) {
                    alert('‚úÖ Campa√±a activada correctamente');
                    console.log('üîÑ Recargando campa√±as...');
                    cargarCampanas(); // Recargar tabla
                    // Cerrar modal si est√° abierto
                    const modal = document.querySelector('div[style*="position:fixed"]');
                    if (modal) modal.remove();
                } else {
                    console.error('‚ùå Error en respuesta:', data.error);
                    alert('‚ùå Error: ' + (data.message || data.error || 'No se pudo activar la campa√±a'));
                }
            } catch (err) {
                console.error('‚ùå Error de conexi√≥n:', err);
                alert('Error de conexi√≥n: ' + err.message);
            }
        };

        window.eliminarCampana = async function(id) {
            console.log('‚úÖ eliminarCampana llamada con ID:', id);
            if (!confirm('¬øSeguro que deseas eliminar esta campa√±a?')) {
                console.log('‚ö†Ô∏è Usuario cancel√≥ la eliminaci√≥n');
                return;
            }
            
            try {
                console.log('üì° Enviando petici√≥n de eliminar...');
                const res = await fetch('api/campanas/actualizar_robusto.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, accion: 'eliminar' })
                });
                const data = await res.json();
                console.log('üìÑ Respuesta eliminar:', data);
                
                if (data.success) {
                    alert('‚úÖ Campa√±a eliminada correctamente');
                    console.log('üîÑ Recargando campa√±as...');
                    cargarCampanas(); // Recargar tabla
                    // Cerrar modal si est√° abierto
                    const modal = document.querySelector('div[style*="position:fixed"]');
                    if (modal) modal.remove();
                } else {
                    console.error('‚ùå Error en respuesta:', data.error);
                    alert('‚ùå Error: ' + (data.message || data.error || 'No se pudo eliminar la campa√±a'));
                }
            } catch (err) {
                console.error('‚ùå Error de conexi√≥n:', err);
                alert('Error de conexi√≥n: ' + err.message);
            }
        };
        
        console.log('‚úÖ Funciones de campa√±as cargadas correctamente');

        function crearCampana() {
            // Mostrar el modal de crear campa√±a
            document.getElementById('modalCampanaTitulo').textContent = 'Crear Nueva Campa√±a';
            const modal = document.getElementById('modalCampana');
            
            // Reset del formulario
            document.getElementById('formCampana').reset();
            
            // Cargar libros disponibles
            cargarLibrosEnSelect();
            
            // Ocultar preview de imagen
            const previewContainer = document.getElementById('previewImagenCampana');
            if (previewContainer) {
                previewContainer.style.display = 'none';
            }
            
            // Deshabilitar bot√≥n de compartir hasta que se guarde
            const btnCompartir = document.getElementById('btnCompartirRed');
            if (btnCompartir) {
                btnCompartir.disabled = true;
            }
            
            // Mostrar el modal
            if (modal) {
                modal.style.display = 'flex';
            } else {
                alert('Funcionalidad de campa√±as disponible. Contacte al administrador del sistema.');
            }
        }

        // === FUNCIONES DE NOTIFICACIONES ===
        window.verNotificacion = async function(id) {
            console.log('‚úÖ verNotificacion llamada con ID:', id);
            try {
                let res = await fetch(`api/notificaciones/admin_listar_robusto.php`);
                let data = await res.json();
                
                if (data.success && data.notificaciones) {
                    const notif = data.notificaciones.find(n => n.id == id) || data.notificaciones[0];
                    const modalContent = `
                        <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center;" onclick="this.remove()">
                            <div style="background:white;padding:2rem;border-radius:8px;max-width:600px;max-height:80vh;overflow:auto;" onclick="event.stopPropagation()">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                                    <h3>Notificaci√≥n #${notif.id}</h3>
                                    <button onclick="this.closest('div[style*=\"position:fixed\"]').remove()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;">&times;</button>
                                </div>
                                <div style="margin-bottom:1rem;">
                                    <strong>T√≠tulo:</strong> ${notif.titulo}<br>
                                    <strong>Tipo:</strong> ${notif.tipo}<br>
                                    <strong>Prioridad:</strong> <span style="color: ${getPrioridadColor(notif.prioridad)}">${notif.prioridad}</span><br>
                                    <strong>Estado:</strong> ${notif.estado}<br>
                                    <strong>Fecha:</strong> ${new Date(notif.fecha_creacion).toLocaleString()}<br>
                                </div>
                                <div style="margin-bottom:1rem;">
                                    <strong>Mensaje:</strong><br>
                                    <div style="background:#f8f9fa;padding:1rem;border-radius:4px;">${notif.mensaje}</div>
                                </div>
                                <div style="display:flex;gap:0.5rem;justify-content:flex-end;">
                                    <button onclick="window.marcarLeida(${notif.id})" class="btn btn-primary">Marcar como Le√≠da</button>
                                    <button onclick="window.eliminarNotificacion(${notif.id})" class="btn btn-danger">Eliminar</button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', modalContent);
                } else {
                    alert('Error: ' + (data.error || 'Notificaci√≥n no encontrada'));
                }
            } catch (err) {
                console.error('‚ùå Error:', err);
                alert('Error de conexi√≥n: ' + err.message);
            }
        };

        window.marcarLeida = async function(id) {
            console.log('‚úÖ marcarLeida llamada con ID:', id);
            try {
                const res = await fetch('api/notificaciones/marcar_leida_robusto.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, accion: 'marcar_leida' })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('‚úÖ Notificaci√≥n marcada como le√≠da');
                    cargarNotificaciones(); // Recargar tabla
                    // Cerrar modal si est√° abierto
                    const modal = document.querySelector('div[style*="position:fixed"]');
                    if (modal) modal.remove();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'No se pudo marcar la notificaci√≥n como le√≠da'));
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error de conexi√≥n: ' + error.message);
            }
        };

        window.eliminarNotificacion = async function(id) {
            console.log('‚úÖ eliminarNotificacion llamada con ID:', id);
            if (!confirm('¬øSeguro que deseas eliminar esta notificaci√≥n?')) return;
            
            try {
                const res = await fetch('api/notificaciones/marcar_leida_robusto.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, accion: 'eliminar' })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('‚úÖ Notificaci√≥n eliminada correctamente');
                    cargarNotificaciones(); // Recargar tabla
                    // Cerrar modal si est√° abierto
                    const modal = document.querySelector('div[style*="position:fixed"]');
                    if (modal) modal.remove();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'No se pudo eliminar la notificaci√≥n'));
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error de conexi√≥n: ' + error.message);
            }
        };

        function crearNotificacion() {
            alert('Funci√≥n crear notificaci√≥n en desarrollo');
        }

        // === FUNCIONES DE CARGA DE DATOS ===
        async function cargarCampanas() {
            console.log('üîÑ Cargando campa√±as...');
            try {
                const response = await fetch('api/campanas/listar_basico.php');
                const data = await response.json();
                
                console.log('üìÑ Respuesta del API:', data);
                
                const tbody = document.getElementById('tablaCampanas');
                
                if (data.success && data.campanas) {
                    console.log('‚úÖ Campa√±as cargadas:', data.campanas.length);
                    
                    tbody.innerHTML = data.campanas.map(campana => `
                        <tr>
                            <td>${campana.id}</td>
                            <td>${campana.nombre}</td>
                            <td>${campana.tipo}</td>
                            <td><span class="badge-status status-${campana.estado.toLowerCase()}">${campana.estado}</span></td>
                            <td>${new Date(campana.fecha_inicio).toLocaleDateString()}</td>
                            <td>${campana.roi}%</td>
                            <td>
                                <button class="btn btn-sm btn-success me-1" onclick="window.verCampana(${campana.id})" title="Ver">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-primary me-1" onclick="window.duplicarCampana(${campana.id})" title="Duplicar">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button class="btn btn-sm btn-warning me-1" onclick="window.activarCampana(${campana.id})" title="Activar">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="window.eliminarCampana(${campana.id})" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    
                    console.log(`‚úÖ ${data.campanas.length} campa√±as cargadas`);
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No se encontraron campa√±as</td></tr>';
                    console.log('‚ÑπÔ∏è No hay campa√±as');
                }
            } catch (error) {
                console.error('‚ùå Error al cargar campa√±as:', error);
                document.getElementById('tablaCampanas').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error al cargar campa√±as</td></tr>';
            }
        }

        async function cargarNotificaciones() {
            console.log('üîÑ Cargando notificaciones...');
            try {
                const response = await fetch('api/notificaciones/admin_listar_robusto.php');
                const data = await response.json();
                
                const tbody = document.getElementById('tablaNotificaciones');
                
                if (data.success && data.notificaciones) {
                    tbody.innerHTML = data.notificaciones.map(notif => `
                        <tr>
                            <td>${notif.id}</td>
                            <td>${notif.titulo}</td>
                            <td>${notif.tipo}</td>
                            <td><span class="badge-status priority-${notif.prioridad.toLowerCase()}">${notif.prioridad}</span></td>
                            <td><span class="badge-status status-${notif.estado.toLowerCase()}">${notif.estado}</span></td>
                            <td>${new Date(notif.fecha_creacion).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-sm btn-success me-1" onclick="window.verNotificacion(${notif.id})" title="Ver">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-primary me-1" onclick="window.marcarLeida(${notif.id})" title="Marcar Le√≠da">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="window.eliminarNotificacion(${notif.id})" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No se encontraron notificaciones</td></tr>';
                }
            } catch (error) {
                console.error('‚ùå Error al cargar notificaciones:', error);
                document.getElementById('tablaNotificaciones').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error al cargar notificaciones</td></tr>';
            }
        }

        // === FUNCIONES DE USUARIOS ===
        window.verUsuario = async function(id) {
            console.log('üîç Obteniendo detalles del usuario ID:', id);
            try {
                const response = await apiRequest(`api/usuarios/admin_panel_gestionar.php?id=${id}`);
                const data = await response.json();
                
                if (data.success && data.usuario) {
                    const u = data.usuario;
                    
                    // Helper function para formatear fechas
                    const formatearFechaCompleta = (fecha) => {
                        if (!fecha || fecha === '0000-00-00 00:00:00') return 'No disponible';
                        try {
                            const date = new Date(fecha);
                            return date.toLocaleDateString('es-ES', {
                                year: 'numeric',
                                month: 'long', 
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        } catch {
                            return fecha;
                        }
                    };
                    
                    // Helper function para obtener badge de rol
                    const getBadgeRol = (rol) => {
                        const badges = {
                            'admin': '<span class="badge bg-danger">üëë Administrador</span>',
                            'escritor': '<span class="badge bg-primary">‚úçÔ∏è Escritor</span>',
                            'afiliado': '<span class="badge bg-success">ü§ù Afiliado</span>',
                            'lector': '<span class="badge bg-secondary">üëÅÔ∏è Lector</span>'
                        };
                        return badges[rol] || `<span class="badge bg-secondary">${rol}</span>`;
                    };
                    
                    // Helper function para obtener badge de estado
                    const getBadgeEstado = (estado) => {
                        const badges = {
                            'activo': '<span class="badge bg-success">‚úÖ Activo</span>',
                            'inactivo': '<span class="badge bg-secondary">‚ö´ Inactivo</span>',
                            'pendiente': '<span class="badge bg-warning">‚è≥ Pendiente</span>',
                            'suspendido': '<span class="badge bg-danger">üö´ Suspendido</span>'
                        };
                        return badges[estado] || `<span class="badge bg-secondary">${estado}</span>`;
                    };
                    
                    const contenidoModal = `
                        <style>
                            .info-section {
                                margin-bottom: 25px;
                                border: 1px solid #e9ecef;
                                border-radius: 8px;
                                padding: 15px;
                                background: #f8f9fa;
                            }
                            .info-section h6 {
                                color: #495057;
                                border-bottom: 2px solid #dee2e6;
                                padding-bottom: 8px;
                                margin-bottom: 15px;
                                font-weight: 600;
                            }
                            .info-item {
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                padding: 8px 0;
                                border-bottom: 1px solid #e9ecef;
                            }
                            .info-item:last-child {
                                border-bottom: none;
                            }
                            .info-label {
                                font-weight: 600;
                                color: #6c757d;
                                min-width: 120px;
                            }
                            .info-value {
                                flex: 1;
                                text-align: right;
                                color: #495057;
                            }
                            .biografia-text {
                                max-height: 100px;
                                overflow-y: auto;
                                background: white;
                                padding: 10px;
                                border-radius: 4px;
                                border: 1px solid #dee2e6;
                                font-style: italic;
                                text-align: left;
                            }
                            .cuenta-payu {
                                font-family: 'Courier New', monospace;
                                background: #f1f3f4;
                                padding: 5px 8px;
                                border-radius: 4px;
                                border: 1px solid #dadce0;
                            }
                            .no-data {
                                color: #6c757d;
                                font-style: italic;
                            }
                            .foto-perfil {
                                width: 80px;
                                height: 80px;
                                border-radius: 50%;
                                object-fit: cover;
                                border: 3px solid #dee2e6;
                            }
                            .foto-placeholder {
                                width: 80px;
                                height: 80px;
                                border-radius: 50%;
                                background: #e9ecef;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 2rem;
                                color: #6c757d;
                                border: 3px solid #dee2e6;
                            }
                        </style>
                        
                        <!-- Secci√≥n: Informaci√≥n Personal -->
                        <div class="info-section">
                            <h6><i class="fas fa-user"></i> Informaci√≥n Personal</h6>
                            
                            <div class="info-item">
                                <span class="info-label">Foto:</span>
                                <span class="info-value">
                                    ${u.foto ? 
                                        `<img src="${u.foto}" alt="Foto de perfil" class="foto-perfil">` : 
                                        `<div class="foto-placeholder"><i class="fas fa-user"></i></div>`
                                    }
                                </span>
                            </div>
                            
                            <div class="info-item">
                                <span class="info-label">Nombre:</span>
                                <span class="info-value"><strong>${u.nombre}</strong></span>
                            </div>
                            
                            <div class="info-item">
                                <span class="info-label">Email:</span>
                                <span class="info-value">
                                    <a href="mailto:${u.email}" class="text-primary">${u.email}</a>
                                </span>
                            </div>
                            
                            <div class="info-item">
                                <span class="info-label">Documento:</span>
                                <span class="info-value"><code>${u.documento || 'No especificado'}</code></span>
                            </div>
                            
                            <div class="info-item">
                                <span class="info-label">Biograf√≠a:</span>
                                <span class="info-value">
                                    ${u.biografia ? 
                                        `<div class="biografia-text">${u.biografia}</div>` : 
                                        `<span class="no-data">Sin biograf√≠a registrada</span>`
                                    }
                                </span>
                            </div>
                        </div>
                        
                        <!-- Secci√≥n: Estado del Sistema -->
                        <div class="info-section">
                            <h6><i class="fas fa-cog"></i> Estado del Sistema</h6>
                            
                            <div class="info-item">
                                <span class="info-label">Rol:</span>
                                <span class="info-value">${getBadgeRol(u.rol)}</span>
                            </div>
                            
                            <div class="info-item">
                                <span class="info-label">Estado:</span>
                                <span class="info-value">${getBadgeEstado(u.estado)}</span>
                            </div>
                            
                            <div class="info-item">
                                <span class="info-label">ID Usuario:</span>
                                <span class="info-value"><code>#${u.id}</code></span>
                            </div>
                        </div>
                        
                        <!-- Secci√≥n: Actividad -->
                        <div class="info-section">
                            <h6><i class="fas fa-clock"></i> Actividad</h6>
                            
                            <div class="info-item">
                                <span class="info-label">Fecha de Registro:</span>
                                <span class="info-value">${formatearFechaCompleta(u.fecha_registro)}</span>
                            </div>
                            
                            <div class="info-item">
                                <span class="info-label">√öltimo Login:</span>
                                <span class="info-value">
                                    ${u.fecha_ultimo_login ? 
                                        formatearFechaCompleta(u.fecha_ultimo_login) : 
                                        '<span class="no-data">Nunca ha iniciado sesi√≥n</span>'
                                    }
                                </span>
                            </div>
                        </div>
                        
                        <!-- Secci√≥n: Configuraci√≥n de Pagos -->
                        <div class="info-section">
                            <h6><i class="fas fa-credit-card"></i> Configuraci√≥n de Pagos</h6>
                            
                            <div class="info-item">
                                <span class="info-label">Cuenta PayU:</span>
                                <span class="info-value">
                                    ${u.cuenta_payu ? 
                                        `<code class="cuenta-payu">${u.cuenta_payu}</code>` : 
                                        `<span class="no-data">‚ö†Ô∏è No configurada</span>`
                                    }
                                </span>
                            </div>
                            
                            ${!u.cuenta_payu ? `
                                <div class="info-item">
                                    <span class="info-label">Estado PayU:</span>
                                    <span class="info-value">
                                        <span class="badge bg-warning">üîß Pendiente de configuraci√≥n</span>
                                    </span>
                                </div>
                            ` : `
                                <div class="info-item">
                                    <span class="info-label">Estado PayU:</span>
                                    <span class="info-value">
                                        <span class="badge bg-success">‚úÖ Configurada</span>
                                    </span>
                                </div>
                            `}
                        </div>
                        
                        <!-- Secci√≥n: Tokens y Seguridad -->
                        ${u.token_activacion ? `
                            <div class="info-section">
                                <h6><i class="fas fa-shield-alt"></i> Seguridad</h6>
                                
                                <div class="info-item">
                                    <span class="info-label">Token Activaci√≥n:</span>
                                    <span class="info-value">
                                        <span class="badge bg-info">üîë Presente</span>
                                    </span>
                                </div>
                                
                                <div class="info-item">
                                    <span class="info-label">Expira:</span>
                                    <span class="info-value">${formatearFechaCompleta(u.fecha_expiracion_token)}</span>
                                </div>
                            </div>
                        ` : ''}
                    `;
                    
                    crearModal(`üë§ Perfil Completo: ${u.nombre}`, contenidoModal, 'fas fa-user-circle');
                } else {
                    alert('‚ùå Error: No se pudo obtener la informaci√≥n del usuario');
                }
            } catch (error) {
                console.error('Error al obtener usuario:', error);
                alert('‚ùå Error al conectar con el servidor');
            }
        };

        window.editarUsuario = async function(id) {
            console.log('‚úèÔ∏è editarUsuario llamada con ID:', id);
            
            try {
                // Obtener datos actuales del usuario
                console.log('üì° Obteniendo datos del usuario...');
                const response = await apiRequest(`api/usuarios/admin_panel_gestionar.php?id=${id}`);
                const result = await response.json();
                
                if (!result.success) {
                    alert('‚ùå Error al obtener datos del usuario: ' + result.error);
                    return;
                }
                
                const usuario = result.usuario;
                console.log('üë§ Datos del usuario obtenidos:', usuario);
                
                // Crear formulario de edici√≥n
                const formulario = `
                    <form id="formEditarUsuario" class="row g-3">
                        <input type="hidden" id="editUsuarioId" value="${usuario.id}">
                        
                        <div class="col-md-6">
                            <label for="editNombre" class="form-label">Nombre Completo *</label>
                            <input type="text" class="form-control" id="editNombre" name="nombre" value="${usuario.nombre}" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="editEmail" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="editEmail" name="email" value="${usuario.email}" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="editDocumento" class="form-label">Documento *</label>
                            <input type="text" class="form-control" id="editDocumento" name="documento" value="${usuario.documento}" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="editRol" class="form-label">Rol *</label>
                            <select class="form-control" id="editRol" name="rol" required>
                                <option value="lector" ${usuario.rol === 'lector' ? 'selected' : ''}>Lector</option>
                                <option value="afiliado" ${usuario.rol === 'afiliado' ? 'selected' : ''}>Afiliado</option>
                                <option value="escritor" ${usuario.rol === 'escritor' ? 'selected' : ''}>Escritor</option>
                                <option value="admin" ${usuario.rol === 'admin' ? 'selected' : ''}>Administrador</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="editEstado" class="form-label">Estado *</label>
                            <select class="form-control" id="editEstado" name="estado" required>
                                <option value="activo" ${usuario.estado === 'activo' ? 'selected' : ''}>Activo</option>
                                <option value="pendiente" ${usuario.estado === 'pendiente' ? 'selected' : ''}>Pendiente</option>
                                <option value="inactivo" ${usuario.estado === 'inactivo' ? 'selected' : ''}>Inactivo</option>
                                <option value="suspendido" ${usuario.estado === 'suspendido' ? 'selected' : ''}>Suspendido</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="editPassword" class="form-label">Nueva Contrase√±a (opcional)</label>
                            <input type="password" class="form-control" id="editPassword" name="password" 
                                   placeholder="Dejar vac√≠o para mantener la actual">
                            <small class="text-muted">Solo llena este campo si quieres cambiar la contrase√±a</small>
                        </div>
                        
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar Cambios
                            </button>
                            <button type="button" class="btn btn-secondary ms-2" onclick="cerrarModal()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </form>
                `;
                
                crearModal(`Editar Usuario: ${usuario.nombre}`, formulario, 'fas fa-edit');
                
                // Configurar el formulario
                document.getElementById('formEditarUsuario').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    const data = {
                        nombre: formData.get('nombre'),
                        email: formData.get('email'),
                        documento: formData.get('documento'),
                        rol: formData.get('rol'),
                        estado: formData.get('estado')
                    };
                    
                    // Solo incluir contrase√±a si se proporcion√≥
                    const password = formData.get('password');
                    if (password && password.trim().length > 0) {
                        if (password.length < 6) {
                            alert('La nueva contrase√±a debe tener al menos 6 caracteres');
                            return;
                        }
                        data.password = password;
                    }
                    
                    // Validaciones b√°sicas
                    if (!data.documento || data.documento.trim().length < 3) {
                        alert('El documento debe tener al menos 3 caracteres');
                        return;
                    }
                    
                    try {
                        console.log('üì§ Enviando datos de actualizaci√≥n:', data);
                        
                        const response = await apiRequest('api/usuarios/admin_panel_gestionar.php', {
                            method: 'PUT',
                            body: JSON.stringify({ id: usuario.id, ...data })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            alert('‚úÖ Usuario actualizado correctamente');
                            cerrarModal();
                            cargarUsuarios(); // Recargar la tabla
                        } else {
                            alert('‚ùå Error: ' + (result.error || 'No se pudo actualizar el usuario'));
                        }
                    } catch (error) {
                        console.error('Error al actualizar usuario:', error);
                        alert('‚ùå Error de conexi√≥n al actualizar el usuario');
                    }
                });
                
            } catch (error) {
                console.error('Error al cargar datos del usuario:', error);
                alert('‚ùå Error al cargar los datos del usuario');
            }
        };

        window.toggleEstadoUsuario = async function(id, estado) {
            console.log('üîÑ Cambiando estado usuario ID:', id, 'a:', estado);
            try {
                const response = await fetch('api/usuarios/admin_panel_gestionar.php', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: id,
                        estado: estado
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ Estado del usuario #${id} cambiado a: ${estado}`);
                    // Recargar la tabla de usuarios
                    cargarUsuarios();
                } else {
                    alert('‚ùå Error al cambiar estado: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error al cambiar estado:', error);
                alert('‚ùå Error al conectar con el servidor');
            }
        };

        window.eliminarUsuario = async function(id) {
            console.log('üóëÔ∏è eliminarUsuario llamada con ID:', id);
            if (!confirm('‚ö†Ô∏è ¬øSeguro que deseas ELIMINAR PERMANENTEMENTE este usuario?\n\nüî• ATENCI√ìN: Esta acci√≥n NO se puede deshacer.\nSe eliminar√°n:\n- El usuario\n- Sus libros (si es escritor)\n- Su registro de afiliado (si es afiliado)\n- Sus notificaciones\n\n¬øContinuar?')) return;
            
            try {
                const response = await apiRequest(`api/usuarios/admin_panel_gestionar.php?id=${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ Usuario #${id} eliminado permanentemente`);
                    // Recargar la tabla de usuarios
                    cargarUsuarios();
                } else {
                    alert('‚ùå Error al eliminar usuario: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error al eliminar usuario:', error);
                alert('‚ùå Error al conectar con el servidor');
            }
        };

        function crearUsuario() {
            const formulario = `
                <form id="formNuevoUsuario" class="row g-3">
                    <div class="col-md-6">
                        <label for="nombre" class="form-label">Nombre Completo *</label>
                        <input type="text" class="form-control" id="nombre" name="nombre" required>
                    </div>
                    <div class="col-md-6">
                        <label for="email" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="col-md-6">
                        <label for="documento" class="form-label">Documento *</label>
                        <input type="text" class="form-control" id="documento" name="documento" required 
                               placeholder="C√©dula, NIT, Pasaporte, etc.">
                    </div>
                    <div class="col-md-6">
                        <label for="rol" class="form-label">Rol *</label>
                        <select class="form-control" id="rol" name="rol" required>
                            <option value="lector">Lector</option>
                            <option value="afiliado">Afiliado</option>
                            <option value="escritor">Escritor</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="estado" class="form-label">Estado *</label>
                        <select class="form-control" id="estado" name="estado" required>
                            <option value="activo">Activo</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="inactivo">Inactivo</option>
                            <option value="suspendido">Suspendido</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label for="password" class="form-label">Contrase√±a *</label>
                        <input type="password" class="form-control" id="password" name="password" required 
                               placeholder="M√≠nimo 6 caracteres">
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Crear Usuario
                        </button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="cerrarModal()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            `;
            
            crearModal('Crear Nuevo Usuario', formulario, 'fas fa-user-plus');
            
            // Configurar el formulario
            document.getElementById('formNuevoUsuario').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const data = {
                    nombre: formData.get('nombre'),
                    email: formData.get('email'),
                    documento: formData.get('documento'),
                    rol: formData.get('rol'),
                    estado: formData.get('estado'),
                    password: formData.get('password')
                };
                
                // Validaciones b√°sicas
                if (data.password.length < 6) {
                    alert('La contrase√±a debe tener al menos 6 caracteres');
                    return;
                }
                
                if (!data.documento || data.documento.trim().length < 3) {
                    alert('El documento debe tener al menos 3 caracteres');
                    return;
                }
                
                try {
                    const response = await apiRequest('api/usuarios/crear.php', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    
                    console.log('Response status:', response.status);
                    console.log('Response headers:', [...response.headers]);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const responseText = await response.text();
                    console.log('Response text:', responseText);
                    
                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (jsonError) {
                        console.error('JSON parse error:', jsonError);
                        console.error('Raw response:', responseText);
                        throw new Error(`Respuesta inv√°lida del servidor: ${responseText.substring(0, 100)}`);
                    }
                    
                    if (result.success) {
                        alert('‚úÖ Usuario creado correctamente');
                        cerrarModal();
                        cargarUsuarios(); // Recargar la tabla de usuarios
                    } else {
                        alert('‚ùå Error: ' + (result.error || 'No se pudo crear el usuario'));
                    }
                } catch (error) {
                    console.error('Error completo:', error);
                    alert('‚ùå Error: ' + error.message);
                }
            });
        }

        // === FUNCIONES DE AFILIADOS ===
        window.verAfiliado = async function(id) {
            console.log('üîç Obteniendo detalles del afiliado ID:', id);
            try {
                const response = await apiRequest(`api/afiliados/admin_panel_gestionar.php?id=${id}`);
                const data = await response.json();
                
                if (data.success && data.afiliado) {
                    const a = data.afiliado;
                    
                    // Helper functions
                    const formatearFechaCompleta = (fecha) => {
                        if (!fecha || fecha === '0000-00-00 00:00:00') return 'No disponible';
                        try {
                            const date = new Date(fecha);
                            return date.toLocaleDateString('es-ES', {
                                year: 'numeric',
                                month: 'long', 
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        } catch {
                            return fecha;
                        }
                    };
                    
                    const obtenerPatrocinador = async (patrocinadorId) => {
                        if (!patrocinadorId) {
                            return '<span class="badge bg-success">üè¢ EMPRESA (Afiliado Directo)</span>';
                        }
                        
                        try {
                            const response = await apiRequest(`api/afiliados/admin_panel_gestionar.php?id=${patrocinadorId}`);
                            const result = await response.json();
                            if (result.success && result.afiliado) {
                                return `<span class="badge bg-info">üë§ ${result.afiliado.nombre}</span> <br><small class="text-muted">C√≥digo: ${result.afiliado.codigo_afiliado}</small>`;
                            }
                        } catch (e) {
                            console.error('Error obteniendo patrocinador:', e);
                        }
                        
                        return `<span class="badge bg-warning">‚ö†Ô∏è ID: ${patrocinadorId} (No encontrado)</span>`;
                    };
                    
                    const getBadgeEstado = (estado) => {
                        const badges = {
                            'activo': '<span class="badge bg-success">‚úÖ Activo</span>',
                            'inactivo': '<span class="badge bg-secondary">‚ö´ Inactivo</span>',
                            'pendiente': '<span class="badge bg-warning">‚è≥ Pendiente</span>',
                            'suspendido': '<span class="badge bg-danger">üö´ Suspendido</span>'
                        };
                        return badges[estado] || `<span class="badge bg-secondary">${estado}</span>`;
                    };
                    
                    const generarEnlaceAfiliado = (codigo) => {
                        const baseUrl = window.location.origin + window.location.pathname.replace('/admin-panel.html', '');
                        return `${baseUrl}/registro.php?ref=${codigo}`;
                    };
                    
                    const enlaceGenerado = generarEnlaceAfiliado(a.codigo_afiliado);
                    const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(enlaceGenerado)}`;
                    
                    // Obtener informaci√≥n del patrocinador
                    const patrocinadorHtml = await obtenerPatrocinador(a.patrocinador_id);
                    
                    const contenidoModal = `
                        <style>
                            .affiliate-section {
                                margin-bottom: 25px;
                                border: 1px solid #e9ecef;
                                border-radius: 8px;
                                padding: 15px;
                                background: #f8f9fa;
                            }
                            .affiliate-section h6 {
                                color: #495057;
                                border-bottom: 2px solid #dee2e6;
                                padding-bottom: 8px;
                                margin-bottom: 15px;
                                font-weight: 600;
                            }
                            .affiliate-item {
                                display: flex;
                                justify-content: space-between;
                                align-items: flex-start;
                                padding: 8px 0;
                                border-bottom: 1px solid #e9ecef;
                            }
                            .affiliate-item:last-child {
                                border-bottom: none;
                            }
                            .affiliate-label {
                                font-weight: 600;
                                color: #6c757d;
                                min-width: 140px;
                            }
                            .affiliate-value {
                                flex: 1;
                                text-align: right;
                                color: #495057;
                            }
                            .money-value {
                                font-family: 'Courier New', monospace;
                                font-weight: bold;
                                color: #28a745;
                                font-size: 1.1em;
                            }
                            .link-box {
                                background: white;
                                border: 1px solid #dee2e6;
                                border-radius: 4px;
                                padding: 10px;
                                font-family: 'Courier New', monospace;
                                font-size: 0.9em;
                                word-break: break-all;
                                text-align: left;
                                margin-top: 5px;
                            }
                            .qr-container {
                                text-align: center;
                                margin-top: 10px;
                            }
                            .qr-image {
                                border: 2px solid #dee2e6;
                                border-radius: 8px;
                                background: white;
                                padding: 10px;
                            }
                            .tools-grid {
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                gap: 10px;
                                margin-top: 10px;
                            }
                            .tool-button {
                                padding: 8px 12px;
                                border: none;
                                border-radius: 4px;
                                font-size: 0.9em;
                                cursor: pointer;
                                text-decoration: none;
                                text-align: center;
                                transition: all 0.3s;
                            }
                            .btn-copy {
                                background: #17a2b8;
                                color: white;
                            }
                            .btn-copy:hover {
                                background: #138496;
                                color: white;
                            }
                            .btn-share {
                                background: #6f42c1;
                                color: white;
                            }
                            .btn-share:hover {
                                background: #5a32a3;
                                color: white;
                            }
                            .btn-download {
                                background: #fd7e14;
                                color: white;
                            }
                            .btn-download:hover {
                                background: #e8610e;
                                color: white;
                            }
                            .btn-email {
                                background: #dc3545;
                                color: white;
                            }
                            .btn-email:hover {
                                background: #c82333;
                                color: white;
                            }
                            .no-data {
                                color: #6c757d;
                                font-style: italic;
                            }
                            .network-stats {
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                border-radius: 8px;
                                padding: 15px;
                                margin-top: 10px;
                            }
                            .stats-row {
                                display: flex;
                                justify-content: space-between;
                                margin-bottom: 8px;
                            }
                        </style>
                        
                        <!-- Informaci√≥n Personal del Afiliado -->
                        <div class="affiliate-section">
                            <h6><i class="fas fa-user-tie"></i> Informaci√≥n Personal</h6>
                            
                            <div class="affiliate-item">
                                <span class="affiliate-label">Nombre Completo:</span>
                                <span class="affiliate-value"><strong>${a.nombre}</strong></span>
                            </div>
                            
                            <div class="affiliate-item">
                                <span class="affiliate-label">Email:</span>
                                <span class="affiliate-value">
                                    <a href="mailto:${a.email}" class="text-primary">${a.email}</a>
                                </span>
                            </div>
                            
                            <div class="affiliate-item">
                                <span class="affiliate-label">C√≥digo Afiliado:</span>
                                <span class="affiliate-value">
                                    <code style="background: #e9ecef; padding: 4px 8px; border-radius: 4px; font-size: 1.1em; font-weight: bold;">${a.codigo_afiliado}</code>
                                </span>
                            </div>
                            
                            <div class="affiliate-item">
                                <span class="affiliate-label">Estado:</span>
                                <span class="affiliate-value">${getBadgeEstado(a.estado_usuario)}</span>
                            </div>
                        </div>
                        
                        <!-- Estructura de Red -->
                        <div class="affiliate-section">
                            <h6><i class="fas fa-sitemap"></i> Estructura de Red</h6>
                            
                            <div class="affiliate-item">
                                <span class="affiliate-label">Patrocinador:</span>
                                <span class="affiliate-value">${patrocinadorHtml}</span>
                            </div>
                            
                            <div class="affiliate-item">
                                <span class="affiliate-label">Nivel en Red:</span>
                                <span class="affiliate-value">
                                    <span class="badge bg-primary">üìä Nivel ${a.nivel || 1}</span>
                                </span>
                            </div>
                            
                            <div class="affiliate-item">
                                <span class="affiliate-label">Afiliados Directos:</span>
                                <span class="affiliate-value">
                                    <span class="badge bg-info">üë• ${a.frontal || 0} afiliados</span>
                                </span>
                            </div>
                        </div>
                        
                        <!-- Comisiones y Rendimiento -->
                        <div class="affiliate-section">
                            <h6><i class="fas fa-chart-line"></i> Comisiones y Rendimiento</h6>
                            
                            <div class="network-stats">
                                <div class="stats-row">
                                    <span>üí∞ Comisi√≥n Total:</span>
                                    <span class="money-value">$${parseFloat(a.comision_total || 0).toLocaleString('es-ES', {minimumFractionDigits: 2})}</span>
                                </div>
                                <div class="stats-row">
                                    <span>üì¶ Ventas Totales:</span>
                                    <span><strong>${parseInt(a.ventas_totales || 0).toLocaleString('es-ES')} unidades</strong></span>
                                </div>
                                <div class="stats-row">
                                    <span>üìà Promedio por Venta:</span>
                                    <span>$${(a.ventas_totales > 0 ? (parseFloat(a.comision_total || 0) / parseInt(a.ventas_totales)).toFixed(2) : '0.00')}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Fechas Importantes -->
                        <div class="affiliate-section">
                            <h6><i class="fas fa-calendar-alt"></i> Fechas Importantes</h6>
                            
                            <div class="affiliate-item">
                                <span class="affiliate-label">Fecha de Activaci√≥n:</span>
                                <span class="affiliate-value">
                                    ${a.fecha_activacion ? 
                                        `<strong>${formatearFechaCompleta(a.fecha_activacion)}</strong>` : 
                                        '<span class="no-data">‚è≥ Pendiente de activaci√≥n</span>'
                                    }
                                </span>
                            </div>
                            
                            <div class="affiliate-item">
                                <span class="affiliate-label">Tiempo Activo:</span>
                                <span class="affiliate-value">
                                    ${a.fecha_activacion ? 
                                        `<span class="badge bg-success">${Math.floor((new Date() - new Date(a.fecha_activacion)) / (1000 * 60 * 60 * 24))} d√≠as</span>` : 
                                        '<span class="badge bg-warning">Sin activar</span>'
                                    }
                                </span>
                            </div>
                        </div>
                        
                        <!-- Enlaces y Herramientas de Afiliado -->
                        <div class="affiliate-section">
                            <h6><i class="fas fa-link"></i> Enlaces y Herramientas de Marketing</h6>
                            
                            <div class="affiliate-item">
                                <span class="affiliate-label">Enlace de Afiliado:</span>
                                <span class="affiliate-value">
                                    <div class="link-box">${enlaceGenerado}</div>
                                </span>
                            </div>
                            
                            <div class="affiliate-item">
                                <span class="affiliate-label">C√≥digo QR:</span>
                                <span class="affiliate-value">
                                    <div class="qr-container">
                                        <img src="${qrCodeUrl}" alt="QR Code del Afiliado" class="qr-image" style="max-width: 120px;">
                                        <br><small class="text-muted">Escaneable con cualquier lector QR</small>
                                    </div>
                                </span>
                            </div>
                            
                            <div class="affiliate-item">
                                <span class="affiliate-label">Herramientas:</span>
                                <span class="affiliate-value">
                                    <div class="tools-grid">
                                        <button class="tool-button btn-copy" onclick="copiarEnlace('${enlaceGenerado}')">
                                            <i class="fas fa-copy"></i> Copiar Enlace
                                        </button>
                                        <button class="tool-button btn-share" onclick="compartirEnRedes('${enlaceGenerado}', '${a.codigo_afiliado}')">
                                            <i class="fas fa-share-alt"></i> Compartir
                                        </button>
                                        <a href="${qrCodeUrl}" download="qr-${a.codigo_afiliado}.png" class="tool-button btn-download">
                                            <i class="fas fa-download"></i> Descargar QR
                                        </a>
                                        <button class="tool-button btn-email" onclick="enviarPorEmail('${a.email}', '${enlaceGenerado}', '${a.codigo_afiliado}')">
                                            <i class="fas fa-envelope"></i> Enviar Email
                                        </button>
                                    </div>
                                </span>
                            </div>
                        </div>
                    `;
                    
                    crearModal(`ü§ù Perfil Completo del Afiliado: ${a.nombre}`, contenidoModal, 'fas fa-user-tie');
                    
                    // Agregar funciones de utilidad para las herramientas
                    window.copiarEnlace = function(enlace) {
                        navigator.clipboard.writeText(enlace).then(() => {
                            alert('‚úÖ Enlace copiado al portapapeles');
                        }).catch(() => {
                            // Fallback para navegadores sin soporte
                            const textArea = document.createElement('textarea');
                            textArea.value = enlace;
                            document.body.appendChild(textArea);
                            textArea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textArea);
                            alert('‚úÖ Enlace copiado al portapapeles');
                        });
                    };
                    
                    window.compartirEnRedes = function(enlace, codigo) {
                        const texto = `¬°√önete a Publiery con mi c√≥digo de afiliado ${codigo}! ${enlace}`;
                        const url = `https://api.whatsapp.com/send?text=${encodeURIComponent(texto)}`;
                        window.open(url, '_blank');
                    };
                    
                    window.enviarPorEmail = function(email, enlace, codigo) {
                        const asunto = `Tu enlace de afiliado Publiery - ${codigo}`;
                        const cuerpo = `Hola,

Aqu√≠ tienes tu enlace personalizado de afiliado para Publiery:

${enlace}

Tu c√≥digo de afiliado es: ${codigo}

¬°Comp√°rtelo y empieza a ganar comisiones!

Saludos,
Equipo Publiery`;
                        
                        const mailtoUrl = `mailto:${email}?subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(cuerpo)}`;
                        window.location.href = mailtoUrl;
                    };
                    
                } else {
                    alert('‚ùå Error: No se pudo obtener la informaci√≥n del afiliado');
                }
            } catch (error) {
                console.error('Error al obtener afiliado:', error);
                alert('‚ùå Error al conectar con el servidor');
            }
        };

        window.toggleEstadoAfiliado = async function(id, estado) {
            console.log('üîÑ Cambiando estado afiliado ID:', id, 'a:', estado);
            try {
                const response = await fetch('api/afiliados/admin_panel_gestionar.php', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: id,
                        accion: estado === 'activo' ? 'activar' : 'desactivar'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ Estado del afiliado #${id} cambiado a: ${estado}`);
                    // Recargar la tabla de afiliados
                    cargarAfiliados();
                } else {
                    alert('‚ùå Error al cambiar estado: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error al cambiar estado:', error);
                alert('‚ùå Error al conectar con el servidor');
            }
        };

        window.eliminarAfiliado = async function(id) {
            console.log('üóëÔ∏è eliminarAfiliado llamada con ID:', id);
            if (!confirm('‚ö†Ô∏è ¬øSeguro que deseas DESACTIVAR este afiliado?\n\nEsta acci√≥n desactivar√° su cuenta de usuario')) return;
            
            try {
                const response = await fetch(`api/afiliados/admin_panel_gestionar.php?id=${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ Afiliado #${id} desactivado correctamente`);
                    // Recargar la tabla de afiliados
                    cargarAfiliados();
                } else {
                    alert('‚ùå Error al desactivar afiliado: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error al eliminar afiliado:', error);
                alert('‚ùå Error al conectar con el servidor');
            }
        };

        // === FUNCIONES DE ESCRITORES ===
        window.verEscritor = async function(id) {
            console.log('üîç Obteniendo detalles del escritor ID:', id);
            try {
                const response = await fetch(`api/escritores/ver_simple.php?id=${id}`);
                const data = await response.json();
                
                if (data.success && data.escritor) {
                    const e = data.escritor;
                    
                    const contenidoModal = `
                        <div class="info-section">
                            <h6><i class="fas fa-pen-nib"></i> Informaci√≥n B√°sica</h6>
                            <div class="info-item">
                                <span class="info-label">Nombre:</span>
                                <span class="info-value">${e.nombre}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Email:</span>
                                <span class="info-value">${e.email}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Estado:</span>
                                <span class="info-value">
                                    <span class="badge-modal ${obtenerBadgeEstado(e.estado)}">${e.estado}</span>
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Fecha Registro:</span>
                                <span class="info-value">${formatearFecha(e.fecha_registro)}</span>
                            </div>
                        </div>
                        
                        <div class="info-section">
                            <h6><i class="fas fa-chart-line"></i> Estad√≠sticas de Publicaci√≥n</h6>
                            <div class="info-item">
                                <span class="info-label">Libros Publicados:</span>
                                <span class="info-value">${e.publicaciones || 0}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Ventas Totales:</span>
                                <span class="info-value">${e.ventas_totales || 0}</span>
                            </div>
                        </div>
                        
                        <div class="info-section">
                            <h6><i class="fas fa-dollar-sign"></i> Informaci√≥n Financiera</h6>
                            <div class="info-item">
                                <span class="info-label">Royalties Totales:</span>
                                <span class="info-value">$${parseFloat(e.royalties_totales || 0).toFixed(2)}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">√öltimo Pago:</span>
                                <span class="info-value">${formatearFecha(e.ultimo_pago) || 'Sin pagos'}</span>
                            </div>
                        </div>
                    `;
                    
                    crearModal(`Detalles del Escritor #${id}`, contenidoModal, 'fas fa-pen-nib');
                } else {
                    alert('‚ùå Error: No se pudo obtener la informaci√≥n del escritor');
                }
            } catch (error) {
                console.error('‚ùå Error obteniendo escritor:', error);
                alert('‚ùå Error de conexi√≥n al obtener el escritor');
            }
        };

        window.toggleEstadoEscritor = async function(id, estado) {
            console.log('üîÑ Cambiando estado del escritor ID:', id, 'Estado:', estado);
            try {
                const response = await fetch(`api/escritores/toggle_estado_simple.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: id })
                });
                
                const data = await response.json();
                console.log('Respuesta toggle estado:', data);
                
                if (data.success) {
                    alert(`‚úÖ Estado del escritor actualizado correctamente\nNuevo estado: ${data.nuevo_estado}`);
                    // Recargar la tabla
                    cargarEscritores();
                } else {
                    alert(`‚ùå Error: ${data.message || 'No se pudo cambiar el estado'}`);
                }
            } catch (error) {
                console.error('‚ùå Error cambiando estado:', error);
                alert('‚ùå Error de conexi√≥n al cambiar el estado');
            }
        };

        window.eliminarEscritor = async function(id) {
            console.log('üóëÔ∏è Eliminando escritor ID:', id);
            if (!confirm('¬øSeguro que deseas eliminar este escritor?\n\nEsta acci√≥n no se puede deshacer.')) return;
            
            try {
                const response = await fetch(`api/escritores/eliminar_simple.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: id })
                });
                
                const data = await response.json();
                console.log('Respuesta eliminar:', data);
                
                if (data.success) {
                    alert('‚úÖ Escritor eliminado correctamente');
                    // Recargar la tabla
                    cargarEscritores();
                } else {
                    alert(`‚ùå Error: ${data.message || 'No se pudo eliminar el escritor'}`);
                }
            } catch (error) {
                console.error('‚ùå Error eliminando escritor:', error);
                alert('‚ùå Error de conexi√≥n al eliminar el escritor');
            }
        };

        // === FUNCIONES DE LIBROS ===
        window.verLibro = async function(id) {
            console.log('üîç Obteniendo detalles del libro ID:', id);
            try {
                const response = await fetch(`api/libros/ver_simple.php?id=${id}`);
                const data = await response.json();
                
                if (data.success && data.libro) {
                    const l = data.libro;
                    
                    const contenidoModal = `
                        <div class="info-section">
                            <h6><i class="fas fa-book"></i> Informaci√≥n B√°sica</h6>
                            <div class="info-item">
                                <span class="info-label">T√≠tulo:</span>
                                <span class="info-value">${l.titulo}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Precio:</span>
                                <span class="info-value">$${parseFloat(l.precio || 0).toFixed(2)}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Estado:</span>
                                <span class="info-value">
                                    <span class="badge-modal ${obtenerBadgeEstado(l.estado)}">${l.estado}</span>
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Fecha Publicaci√≥n:</span>
                                <span class="info-value">${formatearFecha(l.fecha_publicacion)}</span>
                            </div>
                        </div>
                        
                        <div class="info-section">
                            <h6><i class="fas fa-user-edit"></i> Informaci√≥n del Autor</h6>
                            <div class="info-item">
                                <span class="info-label">Autor:</span>
                                <span class="info-value">${l.autor_nombre || 'Sin autor'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Email del Autor:</span>
                                <span class="info-value">${l.autor_email || 'Sin email'}</span>
                            </div>
                        </div>
                        
                        <div class="info-section">
                            <h6><i class="fas fa-chart-bar"></i> Estad√≠sticas de Ventas</h6>
                            <div class="info-item">
                                <span class="info-label">Ventas Totales:</span>
                                <span class="info-value">${l.ventas_totales || 0}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Ingresos Estimados:</span>
                                <span class="info-value">$${(parseFloat(l.precio || 0) * parseInt(l.ventas_totales || 0)).toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                    
                    crearModal(`Detalles del Libro #${id}`, contenidoModal, 'fas fa-book');
                } else {
                    alert('‚ùå Error: No se pudo obtener la informaci√≥n del libro');
                }
            } catch (error) {
                console.error('‚ùå Error obteniendo libro:', error);
                alert('‚ùå Error de conexi√≥n al obtener el libro');
            }
        };

        window.toggleEstadoLibro = async function(id, estadoActual) {
            console.log('üîÑ Cambiando estado del libro ID:', id, 'Estado actual:', estadoActual);
            
            // Determinar la acci√≥n basada en el estado actual
            let accion, nuevoEstado;
            if (estadoActual === 'publicado') {
                accion = 'despublicar';
                nuevoEstado = 'aprobado_autor';
            } else {
                accion = 'publicar';
                nuevoEstado = 'publicado';
            }
            
            if (!confirm(`¬øSeguro que deseas ${accion} este libro?`)) return;
            
            try {
                const response = await fetch(`api/libros/toggle_estado_simple.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: id, estado: estadoActual })
                });
                
                const data = await response.json();
                console.log('Respuesta toggle estado libro:', data);
                
                if (data.success) {
                    const accionRealizada = data.nuevo_estado === 'publicado' ? 'publicado' : 'despublicado';
                    alert(`‚úÖ Libro ${accionRealizada} correctamente\nNuevo estado: ${data.nuevo_estado}`);
                    // Recargar la tabla
                    cargarLibros();
                } else {
                    alert(`‚ùå Error: ${data.error || 'No se pudo cambiar el estado'}`);
                }
            } catch (error) {
                console.error('‚ùå Error cambiando estado libro:', error);
                alert('‚ùå Error de conexi√≥n al cambiar el estado');
            }
        };

        window.eliminarLibro = async function(id) {
            console.log('üóëÔ∏è Archivando libro ID:', id);
            if (!confirm('¬øSeguro que deseas archivar este libro?\n\nEsta acci√≥n cambiar√° el estado a "archivado" pero conservar√° el historial.')) return;
            
            try {
                const response = await fetch(`api/libros/eliminar_simple.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: id })
                });
                
                const data = await response.json();
                console.log('Respuesta archivar libro:', data);
                
                if (data.success) {
                    alert('‚úÖ Libro archivado correctamente');
                    // Recargar la tabla
                    cargarLibros();
                } else {
                    alert(`‚ùå Error: ${data.message || 'No se pudo archivar el libro'}`);
                }
            } catch (error) {
                console.error('‚ùå Error archivando libro:', error);
                alert('‚ùå Error de conexi√≥n al archivar el libro');
            }
        };

        window.crearLibro = async function() {
            console.log('üìö Iniciando creaci√≥n de nuevo libro');
            
            try {
                // Obtener lista de escritores activos
                const responseEscritores = await apiRequest('api/usuarios/admin_panel_listar.php?rol=escritor');
                const dataEscritores = await responseEscritores.json();
                
                if (!dataEscritores.success) {
                    alert('‚ùå Error al cargar escritores');
                    return;
                }
                
                const escritores = dataEscritores.usuarios || [];
                const opcionesEscritores = escritores.map(e => 
                    `<option value="${e.id}">${e.nombre} (${e.email})</option>`
                ).join('');
                
                if (escritores.length === 0) {
                    alert('‚ö†Ô∏è No hay escritores activos disponibles. Primero crea un usuario con rol "escritor".');
                    return;
                }
                
                const contenidoModal = `
                    <style>
                        .book-form-section {
                            margin-bottom: 25px;
                            padding: 20px;
                            border: 1px solid #e9ecef;
                            border-radius: 8px;
                            background: #f8f9fa;
                        }
                        .book-form-section h6 {
                            color: #495057;
                            border-bottom: 2px solid #dee2e6;
                            padding-bottom: 8px;
                            margin-bottom: 15px;
                            font-weight: 600;
                        }
                        .form-group-custom {
                            margin-bottom: 15px;
                        }
                        .form-label-custom {
                            font-weight: 600;
                            color: #495057;
                            margin-bottom: 5px;
                            display: block;
                        }
                        .form-control-custom {
                            width: 100%;
                            padding: 10px 12px;
                            border: 1px solid #ced4da;
                            border-radius: 4px;
                            font-size: 14px;
                            transition: border-color 0.3s;
                        }
                        .form-control-custom:focus {
                            outline: none;
                            border-color: #007bff;
                            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
                        }
                        .price-info {
                            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                            color: white;
                            padding: 15px;
                            border-radius: 8px;
                            margin-top: 10px;
                        }
                        .price-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 8px;
                        }
                        .help-text {
                            font-size: 12px;
                            color: #6c757d;
                            margin-top: 5px;
                        }
                        .required-field::after {
                            content: " *";
                            color: #dc3545;
                            font-weight: bold;
                        }
                        .categoria-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 10px;
                            margin-top: 10px;
                        }
                        .categoria-option {
                            display: flex;
                            align-items: center;
                            padding: 8px 12px;
                            border: 1px solid #dee2e6;
                            border-radius: 4px;
                            background: white;
                            cursor: pointer;
                            transition: all 0.3s;
                        }
                        .categoria-option:hover {
                            background: #f8f9fa;
                            border-color: #007bff;
                        }
                        .categoria-option input[type="radio"] {
                            margin-right: 8px;
                        }
                    </style>
                    
                    <form id="formCrearLibro" onsubmit="return false;">
                        <!-- Informaci√≥n B√°sica del Libro -->
                        <div class="book-form-section">
                            <h6><i class="fas fa-book"></i> Informaci√≥n B√°sica</h6>
                            
                            <div class="form-group-custom">
                                <label class="form-label-custom required-field">T√≠tulo del Libro</label>
                                <input type="text" name="titulo" class="form-control-custom" 
                                       placeholder="Ingresa el t√≠tulo completo del libro" required maxlength="200">
                                <div class="help-text">M√°ximo 200 caracteres. Debe ser √∫nico por autor.</div>
                            </div>
                            
                            <div class="form-group-custom">
                                <label class="form-label-custom required-field">Autor (Escritor)</label>
                                <select name="autor_id" class="form-control-custom" required>
                                    <option value="">Selecciona un escritor...</option>
                                    ${opcionesEscritores}
                                </select>
                                <div class="help-text">Solo se muestran escritores con estado activo.</div>
                            </div>
                            
                            <div class="form-group-custom">
                                <label class="form-label-custom">Descripci√≥n</label>
                                <textarea name="descripcion" class="form-control-custom" rows="4" 
                                          placeholder="Describe brevemente el contenido del libro, g√©nero, tem√°tica principal..."></textarea>
                                <div class="help-text">Descripci√≥n opcional que aparecer√° en la ficha del libro.</div>
                            </div>
                        </div>
                        
                        <!-- Clasificaci√≥n -->
                        <div class="book-form-section">
                            <h6><i class="fas fa-tags"></i> Clasificaci√≥n</h6>
                            
                            <div class="form-group-custom">
                                <label class="form-label-custom required-field">Categor√≠a</label>
                                <div class="categoria-grid">
                                    <label class="categoria-option">
                                        <input type="radio" name="categoria" value="Ficci√≥n" required>
                                        <span>üìö Ficci√≥n</span>
                                    </label>
                                    <label class="categoria-option">
                                        <input type="radio" name="categoria" value="No Ficci√≥n" required>
                                        <span>üìñ No Ficci√≥n</span>
                                    </label>
                                    <label class="categoria-option">
                                        <input type="radio" name="categoria" value="Biograf√≠a" required>
                                        <span>üë§ Biograf√≠a</span>
                                    </label>
                                    <label class="categoria-option">
                                        <input type="radio" name="categoria" value="Historia" required>
                                        <span>üèõÔ∏è Historia</span>
                                    </label>
                                    <label class="categoria-option">
                                        <input type="radio" name="categoria" value="Ciencia" required>
                                        <span>üî¨ Ciencia</span>
                                    </label>
                                    <label class="categoria-option">
                                        <input type="radio" name="categoria" value="Tecnolog√≠a" required>
                                        <span>üíª Tecnolog√≠a</span>
                                    </label>
                                    <label class="categoria-option">
                                        <input type="radio" name="categoria" value="Autoayuda" required>
                                        <span>üåü Autoayuda</span>
                                    </label>
                                    <label class="categoria-option">
                                        <input type="radio" name="categoria" value="Negocio" required>
                                        <span>üíº Negocio</span>
                                    </label>
                                    <label class="categoria-option">
                                        <input type="radio" name="categoria" value="Romance" required>
                                        <span>üíï Romance</span>
                                    </label>
                                    <label class="categoria-option">
                                        <input type="radio" name="categoria" value="Misterio" required>
                                        <span>üîç Misterio</span>
                                    </label>
                                    <label class="categoria-option">
                                        <input type="radio" name="categoria" value="Infantil" required>
                                        <span>üß∏ Infantil</span>
                                    </label>
                                    <label class="categoria-option">
                                        <input type="radio" name="categoria" value="Otro" required>
                                        <span>üìã Otro</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Configuraci√≥n Comercial -->
                        <div class="book-form-section">
                            <h6><i class="fas fa-dollar-sign"></i> Configuraci√≥n Comercial</h6>
                            
                            <div class="form-group-custom">
                                <label class="form-label-custom required-field">Precio de Venta (USD)</label>
                                <input type="number" name="precio" class="form-control-custom" 
                                       placeholder="0.00" min="0" step="0.01" required 
                                       onchange="calcularPreciosAfiliado(this.value)">
                                <div class="help-text">Precio base para lectores regulares.</div>
                            </div>
                            
                            <div class="price-info" id="infoPrecios" style="display: none;">
                                <div class="price-row">
                                    <span><strong>üí∞ Precio Regular:</strong></span>
                                    <span id="precioRegular">$0.00</span>
                                </div>
                                <div class="price-row">
                                    <span><strong>ü§ù Precio Afiliado (30% desc.):</strong></span>
                                    <span id="precioAfiliado">$0.00</span>
                                </div>
                                <div class="price-row">
                                    <span><strong>üìà Comisi√≥n por Venta:</strong></span>
                                    <span id="comisionVenta">$0.00 (30%)</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Estado Inicial -->
                        <div class="book-form-section">
                            <h6><i class="fas fa-cog"></i> Estado Inicial</h6>
                            
                            <div class="form-group-custom">
                                <label class="form-label-custom">Estado del Libro</label>
                                <select name="estado" class="form-control-custom">
                                    <option value="pendiente_revision">‚è≥ Pendiente de Revisi√≥n</option>
                                    <option value="en_revision">üëÄ En Revisi√≥n</option>
                                    <option value="correccion_autor">‚úèÔ∏è Correcci√≥n del Autor</option>
                                    <option value="aprobado_autor">‚úÖ Aprobado por Autor</option>
                                    <option value="publicado">üåü Publicado</option>
                                </select>
                                <div class="help-text">Por defecto se crea en "Pendiente de Revisi√≥n".</div>
                            </div>
                        </div>
                        
                        <!-- Botones de Acci√≥n -->
                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <button type="button" class="btn btn-secondary" onclick="cerrarModal()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button type="button" class="btn btn-primary" onclick="procesarCreacionLibro()">
                                <i class="fas fa-save"></i> Crear Libro
                            </button>
                        </div>
                    </form>
                `;
                
                crearModal('üìö Crear Nuevo Libro', contenidoModal, 'fas fa-book', 'modal-lg');
                
                // Funci√≥n para calcular precios
                window.calcularPreciosAfiliado = function(precio) {
                    if (!precio || precio <= 0) {
                        document.getElementById('infoPrecios').style.display = 'none';
                        return;
                    }
                    
                    const precioNum = parseFloat(precio);
                    const precioAfiliado = precioNum * 0.70;
                    const comision = precioNum * 0.30;
                    
                    document.getElementById('precioRegular').textContent = '$' + precioNum.toFixed(2);
                    document.getElementById('precioAfiliado').textContent = '$' + precioAfiliado.toFixed(2);
                    document.getElementById('comisionVenta').textContent = '$' + comision.toFixed(2) + ' (30%)';
                    document.getElementById('infoPrecios').style.display = 'block';
                };
                
                // Funci√≥n para procesar la creaci√≥n
                window.procesarCreacionLibro = async function() {
                    const form = document.getElementById('formCrearLibro');
                    const formData = new FormData(form);
                    
                    // Validar campos requeridos
                    const titulo = formData.get('titulo')?.trim();
                    const autor_id = formData.get('autor_id');
                    const categoria = formData.get('categoria');
                    const precio = formData.get('precio');
                    
                    if (!titulo) {
                        alert('‚ùå El t√≠tulo es obligatorio');
                        return;
                    }
                    
                    if (!autor_id) {
                        alert('‚ùå Debe seleccionar un autor');
                        return;
                    }
                    
                    if (!categoria) {
                        alert('‚ùå Debe seleccionar una categor√≠a');
                        return;
                    }
                    
                    if (!precio || precio <= 0) {
                        alert('‚ùå El precio debe ser mayor a 0');
                        return;
                    }
                    
                    // Preparar datos para env√≠o
                    const datosLibro = {
                        titulo: titulo,
                        autor_id: parseInt(autor_id),
                        descripcion: formData.get('descripcion')?.trim() || '',
                        categoria: categoria,
                        precio: parseFloat(precio),
                        estado: formData.get('estado') || 'pendiente_revision'
                    };
                    
                    try {
                        // Mostrar indicador de carga
                        const btnCrear = document.querySelector('[onclick="procesarCreacionLibro()"]');
                        const textoOriginal = btnCrear.innerHTML;
                        btnCrear.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando...';
                        btnCrear.disabled = true;
                        
                        const response = await apiRequest('api/libros/admin_crear.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(datosLibro)
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            alert('‚úÖ Libro creado exitosamente');
                            cerrarModal();
                            // Recargar lista de libros
                            cargarLibros();
                        } else {
                            alert('‚ùå Error al crear libro: ' + (result.error || 'Error desconocido'));
                        }
                        
                    } catch (error) {
                        console.error('Error creando libro:', error);
                        alert('‚ùå Error de conexi√≥n al crear el libro');
                    } finally {
                        // Restaurar bot√≥n
                        const btnCrear = document.querySelector('[onclick="procesarCreacionLibro()"]');
                        if (btnCrear) {
                            btnCrear.innerHTML = textoOriginal;
                            btnCrear.disabled = false;
                        }
                    }
                };
                
            } catch (error) {
                console.error('Error al preparar modal de creaci√≥n:', error);
                alert('‚ùå Error al preparar el formulario de creaci√≥n');
            }
        };

        // === FUNCIONES DE TESTIMONIOS ===
        window.verTestimonio = async function(id) {
            console.log('‚úÖ verTestimonio llamada con ID:', id);
            alert(`Ver testimonio #${id}\n\nFuncionalidad en desarrollo`);
        };

        window.aprobarTestimonio = async function(id) {
            console.log('‚úÖ Aprobando testimonio ID:', id);
            try {
                const response = await fetch('api/testimonios/admin_panel_gestionar.php', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: id,
                        accion: 'aprobar'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ Testimonio #${id} APROBADO correctamente`);
                    // Recargar la tabla de testimonios
                    cargarTestimonios();
                } else {
                    alert('‚ùå Error al aprobar testimonio: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error al aprobar testimonio:', error);
                alert('‚ùå Error al conectar con el servidor');
            }
        };

        window.rechazarTestimonio = async function(id) {
            console.log('‚ùå Rechazando testimonio ID:', id);
            if (!confirm('‚ö†Ô∏è ¬øSeguro que deseas RECHAZAR este testimonio?')) return;
            
            try {
                const response = await fetch('api/testimonios/admin_panel_gestionar.php', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: id,
                        accion: 'rechazar'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`‚úÖ Testimonio #${id} RECHAZADO correctamente`);
                    // Recargar la tabla de testimonios
                    cargarTestimonios();
                } else {
                    alert('‚ùå Error al rechazar testimonio: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error al rechazar testimonio:', error);
                alert('‚ùå Error al conectar con el servidor');
            }
        };

        window.verTestimonio = async function(id) {
            console.log('üîç Obteniendo testimonio ID:', id);
            try {
                const response = await fetch(`api/testimonios/admin_panel_gestionar.php?id=${id}`);
                const data = await response.json();
                
                if (data.success && data.testimonio) {
                    const t = data.testimonio;
                    const estrellas = '‚≠ê'.repeat(t.calificacion);
                    alert(`TESTIMONIO COMPLETO #${id}
                    
üë§ USUARIO:
‚Ä¢ Nombre: ${t.nombre}
‚Ä¢ Email: ${t.email}

‚≠ê CALIFICACI√ìN: ${estrellas} (${t.calificacion}/5)

üí¨ MENSAJE COMPLETO:
"${t.testimonio}"

üìä ESTADO: ${t.estado.toUpperCase()}
üèÜ Destacado: ${t.es_destacado ? 'S√ç' : 'NO'}

üìÖ FECHAS:
‚Ä¢ Enviado: ${new Date(t.fecha_envio).toLocaleString()}
‚Ä¢ Revisado: ${t.fecha_revision ? new Date(t.fecha_revision).toLocaleString() : 'Sin revisar'}

üë®‚Äçüíº Admin Revisor: ${t.admin_revisor_id || 'Sin asignar'}
üìù Observaciones: ${t.observaciones_admin || 'Sin observaciones'}`);
                } else {
                    alert('‚ùå Error: No se pudo obtener el testimonio');
                }
            } catch (error) {
                console.error('Error al obtener testimonio:', error);
                alert('‚ùå Error al conectar con el servidor');
            }
        };

        function crearTestimonio() {
            alert('Crear nuevo testimonio\n\nFuncionalidad en desarrollo');
        }

        // === FUNCIONES DE CARGA DE DATOS ===
        async function cargarUsuarios() {
            console.log('üîÑ Cargando usuarios desde API real...');
            try {
                const response = await fetch('api/usuarios/admin_panel_listar.php');
                const data = await response.json();
                
                const tbody = document.getElementById('tablaUsuarios');
                
                if (data.success && data.usuarios) {
                    tbody.innerHTML = data.usuarios.map(usuario => `
                        <tr>
                            <td>${usuario.id}</td>
                            <td>${usuario.nombre}</td>
                            <td>${usuario.email}</td>
                            <td><span class="badge bg-info">${usuario.rol}</span></td>
                            <td><span class="badge-status status-${usuario.estado.toLowerCase()}">${usuario.estado}</span></td>
                            <td>${new Date(usuario.fecha_registro).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-sm btn-success me-1" onclick="window.verUsuario(${usuario.id})" title="Ver">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-primary me-1" onclick="window.editarUsuario(${usuario.id})" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-warning me-1" onclick="window.toggleEstadoUsuario(${usuario.id}, '${usuario.estado === 'activo' ? 'inactivo' : 'activo'}')" title="${usuario.estado === 'activo' ? 'Desactivar' : 'Activar'}">
                                    <i class="fas fa-${usuario.estado === 'activo' ? 'ban' : 'check'}"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="window.eliminarUsuario(${usuario.id})" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    console.log(`‚úÖ ${data.usuarios.length} usuarios cargados desde BD`);
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No se encontraron usuarios</td></tr>';
                }
            } catch (error) {
                console.error('‚ùå Error al cargar usuarios:', error);
                document.getElementById('tablaUsuarios').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error al cargar usuarios</td></tr>';
            }
        }

        async function cargarAfiliados() {
            console.log('üîÑ Cargando afiliados desde API real...');
            try {
                const response = await fetch('api/afiliados/admin_panel_listar.php');
                const data = await response.json();
                
                const tbody = document.getElementById('tablaAfiliados');
                
                if (data.success && data.afiliados) {
                    tbody.innerHTML = data.afiliados.map(afiliado => `
                        <tr>
                            <td>${afiliado.id}</td>
                            <td>${afiliado.nombre}</td>
                            <td>${afiliado.email}</td>
                            <td>${afiliado.codigo || 'N/A'}</td>
                            <td>${afiliado.referidos || 0}</td>
                            <td>$${parseFloat(afiliado.comisiones || 0).toFixed(2)}</td>
                            <td><span class="badge-status status-${afiliado.estado.toLowerCase()}">${afiliado.estado}</span></td>
                            <td>
                                <button class="btn btn-sm btn-success me-1" onclick="window.verAfiliado(${afiliado.id})" title="Ver">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning me-1" onclick="window.toggleEstadoAfiliado(${afiliado.id}, '${afiliado.estado === 'activo' ? 'inactivo' : 'activo'}')" title="${afiliado.estado === 'activo' ? 'Desactivar' : 'Activar'}">
                                    <i class="fas fa-${afiliado.estado === 'activo' ? 'ban' : 'check'}"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="window.eliminarAfiliado(${afiliado.id})" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    console.log(`‚úÖ ${data.afiliados.length} afiliados cargados desde BD`);
                } else {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">No se encontraron afiliados</td></tr>';
                }
            } catch (error) {
                console.error('‚ùå Error al cargar afiliados:', error);
                document.getElementById('tablaAfiliados').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar afiliados</td></tr>';
            }
        }

        async function cargarEscritores() {
            console.log('üîÑ Cargando escritores desde API real...');
            try {
                const response = await fetch('api/escritores/admin_panel_listar.php');
                const data = await response.json();
                
                const tbody = document.getElementById('tablaEscritores');
                
                if (data.success && data.escritores) {
                    tbody.innerHTML = data.escritores.map(escritor => `
                        <tr>
                            <td>${escritor.id}</td>
                            <td>${escritor.nombre}</td>
                            <td>${escritor.email}</td>
                            <td>${escritor.libros_publicados || 0}</td>
                            <td>$${parseFloat(escritor.royalties_totales || 0).toFixed(2)}</td>
                            <td><span class="badge-status status-${escritor.estado.toLowerCase()}">${escritor.estado}</span></td>
                            <td>${new Date(escritor.fecha_registro).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-sm btn-success me-1" onclick="window.verEscritor(${escritor.id})" title="Ver">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning me-1" onclick="window.toggleEstadoEscritor(${escritor.id}, '${escritor.estado === 'activo' ? 'inactivo' : 'activo'}')" title="${escritor.estado === 'activo' ? 'Desactivar' : 'Activar'}">
                                    <i class="fas fa-${escritor.estado === 'activo' ? 'ban' : 'check'}"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="window.eliminarEscritor(${escritor.id})" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    console.log(`‚úÖ ${data.escritores.length} escritores cargados desde BD`);
                } else {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">No se encontraron escritores</td></tr>';
                }
            } catch (error) {
                console.error('‚ùå Error al cargar escritores:', error);
                document.getElementById('tablaEscritores').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar escritores</td></tr>';
            }
        }

        async function cargarLibros() {
            console.log('üîÑ Cargando libros desde API real...');
            try {
                const response = await fetch('api/libros/admin_panel_listar.php');
                const data = await response.json();
                
                const tbody = document.getElementById('tablaLibros');
                
                if (data.success && data.libros) {
                    // Filtrar libros archivados y con estado vac√≠o de la vista principal
                    const librosActivos = data.libros.filter(libro => 
                        libro.estado !== 'archivado' && 
                        libro.estado !== '' && 
                        libro.estado !== null && 
                        libro.estado !== undefined
                    );
                    
                    if (librosActivos.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" class="text-center">No se encontraron libros activos</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = librosActivos.map(libro => `
                        <tr>
                            <td>${libro.id}</td>
                            <td>${libro.titulo}</td>
                            <td>${libro.autor || 'Sin autor'}</td>
                            <td>${libro.categoria || 'Sin categor√≠a'}</td>
                            <td><strong>$${parseFloat(libro.precio || 0).toFixed(2)}</strong></td>
                            <td><span class="text-success">$${parseFloat(libro.precio_afiliado || 0).toFixed(2)}</span> <small class="text-muted">(30% desc.)</small></td>
                            <td><span class="badge-status status-${libro.estado.toLowerCase()}">${libro.estado}</span></td>
                            <td>${libro.total_ventas || 0}</td>
                            <td>
                                <button class="btn btn-sm btn-success me-1" onclick="window.verLibro(${libro.id})" title="Ver">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning me-1" onclick="window.toggleEstadoLibro(${libro.id}, '${libro.estado}')" title="${libro.estado === 'publicado' ? 'Despublicar' : 'Publicar'}">
                                    <i class="fas fa-${libro.estado === 'publicado' ? 'ban' : 'check'}"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="window.eliminarLibro(${libro.id})" title="Archivar">
                                    <i class="fas fa-archive"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    console.log(`‚úÖ ${librosActivos.length} libros activos cargados (${data.libros.length - librosActivos.length} archivados ocultos)`);
                } else {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center">No se encontraron libros</td></tr>';
                }
            } catch (error) {
                console.error('‚ùå Error al cargar libros:', error);
                document.getElementById('tablaLibros').innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error al cargar libros</td></tr>';
            }
        }

        async function cargarRevision() {
            console.log('üîÑ Cargando libros para revisi√≥n...');
            const tbody = document.getElementById('tablaRevision');
            
            try {
                // Mostrar loading
                tbody.innerHTML = `
                    <tr><td colspan="6" class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> Cargando libros para revisi√≥n...
                    </td></tr>
                `;
                
                // Llamar a la API de revisi√≥n
                const response = await fetch('api/admin/libros_revision.php');
                const data = await response.json();
                
                console.log('üìä Datos de revisi√≥n recibidos:', data);
                
                if (data.success && data.data && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(libro => `
                        <tr>
                            <td><strong>#${libro.id}</strong></td>
                            <td>
                                <strong>${libro.titulo}</strong>
                                <small class="d-block text-muted">${libro.descripcion.substring(0, 50)}...</small>
                            </td>
                            <td>${libro.autor_nombre || 'Sin autor'}</td>
                            <td>
                                <span class="badge bg-warning text-dark">Pendiente Revisi√≥n</span>
                                <small class="d-block">${libro.fecha_registro_formateada}</small>
                            </td>
                            <td>
                                <span class="badge bg-success">${libro.precio_formateado}</span>
                                <small class="d-block">${libro.categoria || 'Sin categor√≠a'}</small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm mb-2">
                                    ${libro.tiene_archivo ? '<i class="fas fa-file-pdf text-danger" title="PDF disponible"></i>' : '<i class="fas fa-exclamation-triangle text-warning" title="Sin PDF"></i>'}
                                    ${libro.tiene_portada ? '<i class="fas fa-image text-info ms-1" title="Portada disponible"></i>' : ''}
                                    ${libro.tiene_archivo ? `<a href="uploads/libros/${libro.archivo_original}" target="_blank" class="btn btn-outline-primary btn-sm ms-2" title="Descargar PDF"><i class="fas fa-download"></i> PDF</a>` : ''}
                                    ${libro.tiene_portada ? `<a href="uploads/portadas/${libro.imagen_portada}" target="_blank" class="btn btn-outline-info btn-sm" title="Ver portada"><i class="fas fa-image"></i> Portada</a>` : ''}
                                </div>
                                <div class="btn-group btn-group-sm d-block">
                                    <button class="btn btn-primary btn-sm" onclick="marcarEnRevision(${libro.id})" title="Marcar como en revisi√≥n">
                                        <i class="fas fa-eye"></i> En Revisi√≥n
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="aprobarLibro(${libro.id})" title="Aprobar y publicar">
                                        <i class="fas fa-check"></i> Aprobar
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="rechazarLibro(${libro.id})" title="Rechazar libro">
                                        <i class="fas fa-times"></i> Rechazar
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                    
                    // Actualizar contador en el men√∫
                    const menuBadge = document.querySelector('.nav-link[onclick="showSection(\'revision\')"] .badge');
                    if (menuBadge) {
                        menuBadge.textContent = data.total;
                    }
                    
                } else {
                    tbody.innerHTML = `
                        <tr><td colspan="6" class="text-center text-muted">
                            <i class="fas fa-inbox"></i><br>
                            No hay libros pendientes de revisi√≥n
                        </td></tr>
                    `;
                }
                
            } catch (error) {
                console.error('‚ùå Error al cargar libros para revisi√≥n:', error);
                tbody.innerHTML = `
                    <tr><td colspan="6" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        Error al cargar libros para revisi√≥n
                    </td></tr>
                `;
            }
        }

        async function cargarArchivados() {
            console.log('üìÅ Cargando libros archivados...');
            try {
                const response = await fetch('api/libros/admin_panel_listar.php?estado=archivado');
                const data = await response.json();
                
                const tbody = document.getElementById('tablaArchivados');
                
                if (data.success && data.libros && data.libros.length > 0) {
                    tbody.innerHTML = data.libros.map(libro => `
                        <tr>
                            <td><strong>#${libro.id}</strong></td>
                            <td><strong>${libro.titulo}</strong></td>
                            <td>${libro.autor || 'Sin autor'}</td>
                            <td><span class="badge bg-secondary">${libro.categoria || 'Sin categor√≠a'}</span></td>
                            <td>${formatearFecha(libro.fecha_registro)}</td>
                            <td><span class="badge bg-info">Archivado</span></td>
                            <td>
                                <button class="btn btn-sm btn-success me-1" onclick="window.verLibro(${libro.id})" title="Ver Detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-primary me-1" onclick="restaurarLibro(${libro.id})" title="Restaurar">
                                    <i class="fas fa-undo"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="eliminarLibroDefinitivo(${libro.id})" title="Eliminar Definitivamente">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    console.log(`‚úÖ ${data.libros.length} libros archivados cargados`);
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay libros archivados</td></tr>';
                }
            } catch (error) {
                console.error('‚ùå Error al cargar libros archivados:', error);
                document.getElementById('tablaArchivados').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error al cargar libros archivados</td></tr>';
            }
        }

        // Funci√≥n para restaurar un libro archivado
        window.restaurarLibro = async function(id) {
            console.log('üîÑ Restaurando libro ID:', id);
            if (!confirm('¬øSeguro que deseas restaurar este libro?\n\nEl libro volver√° al estado "aprobado_autor" y estar√° disponible para publicaci√≥n.')) return;
            
            try {
                const response = await fetch('api/libros/restaurar.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: id })
                });
                
                const data = await response.json();
                console.log('Respuesta restaurar libro:', data);
                
                if (data.success) {
                    alert('‚úÖ Libro restaurado correctamente\nEstado: aprobado_autor');
                    // Recargar la tabla de archivados
                    cargarArchivados();
                } else {
                    alert(`‚ùå Error al restaurar: ${data.error || 'Error desconocido'}`);
                }
            } catch (error) {
                console.error('‚ùå Error restaurando libro:', error);
                alert('‚ùå Error de conexi√≥n al restaurar el libro');
            }
        };

        // Funci√≥n para eliminar definitivamente un libro
        window.eliminarLibroDefinitivo = async function(id) {
            console.log('üóëÔ∏è Eliminando definitivamente libro ID:', id);
            if (!confirm('‚ö†Ô∏è ATENCI√ìN: Esta acci√≥n eliminar√° el libro DEFINITIVAMENTE\n\nEsta acci√≥n NO se puede deshacer.\n\n¬øEst√°s seguro?')) return;
            
            // Doble confirmaci√≥n para eliminaci√≥n definitiva
            if (!confirm('üö® CONFIRMACI√ìN FINAL\n\nEsto eliminar√° PERMANENTEMENTE el libro y todos sus datos.\n\n¬øConfirmas la eliminaci√≥n definitiva?')) return;
            
            try {
                const response = await fetch('api/libros/eliminar_definitivo.php', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: id })
                });
                
                const data = await response.json();
                console.log('Respuesta eliminar definitivo:', data);
                
                if (data.success) {
                    alert('‚úÖ Libro eliminado definitivamente');
                    // Recargar la tabla de archivados
                    cargarArchivados();
                } else {
                    alert(`‚ùå Error al eliminar: ${data.error || 'Error desconocido'}`);
                }
            } catch (error) {
                console.error('‚ùå Error eliminando libro:', error);
                alert('‚ùå Error de conexi√≥n al eliminar el libro');
            }
        };

        async function cargarVentas() {
            console.log('üîÑ Cargando ventas desde API real...');
            try {
                const response = await fetch('api/ventas/admin_panel_listar.php');
                const data = await response.json();
                
                const tbody = document.getElementById('tablaVentas');
                
                if (data.success && data.ventas) {
                    tbody.innerHTML = data.ventas.map(venta => `
                        <tr>
                            <td>${venta.id}</td>
                            <td>${venta.libro_titulo || 'Sin t√≠tulo'}</td>
                            <td>${venta.comprador_nombre || 'Sin nombre'}</td>
                            <td>${venta.afiliado_nombre || 'Sin afiliado'}</td>
                            <td>$${parseFloat(venta.precio || 0).toFixed(2)}</td>
                            <td>$${parseFloat(venta.comision_afiliado || 0).toFixed(2)}</td>
                            <td>${new Date(venta.fecha_venta).toLocaleDateString()}</td>
                            <td><span class="badge-status status-${venta.estado.toLowerCase()}">${venta.estado}</span></td>
                        </tr>
                    `).join('');
                    console.log(`‚úÖ ${data.ventas.length} ventas cargadas desde BD`);
                } else {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">No se encontraron ventas</td></tr>';
                }
            } catch (error) {
                console.error('‚ùå Error al cargar ventas:', error);
                document.getElementById('tablaVentas').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar ventas</td></tr>';
            }
        }

        async function cargarPagos() {
            console.log('üîÑ Cargando pagos...');
            const tbody = document.getElementById('tablaPagos');
            tbody.innerHTML = `
                <tr><td colspan="7" class="text-center">No hay pagos pendientes</td></tr>
            `;
        }

        async function cargarTestimonios() {
            console.log('üîÑ Cargando testimonios desde API real...');
            try {
                const response = await fetch('api/testimonios/admin_panel_listar.php');
                const data = await response.json();
                
                const tbody = document.getElementById('tablaTestimonios');
                
                if (data.success && data.testimonios) {
                    tbody.innerHTML = data.testimonios.map(testimonio => {
                        const estrellas = '‚≠ê'.repeat(testimonio.calificacion);
                        return `
                        <tr>
                            <td>${testimonio.id}</td>
                            <td>${testimonio.usuario_nombre || 'Usuario an√≥nimo'}</td>
                            <td>${testimonio.libro_titulo || 'Sin libro'}</td>
                            <td>${estrellas} (${testimonio.calificacion})</td>
                            <td><span class="badge-status status-${testimonio.estado.toLowerCase()}">${testimonio.estado}</span></td>
                            <td>${new Date(testimonio.fecha_testimonio).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-sm btn-success me-1" onclick="window.aprobarTestimonio(${testimonio.id})" title="Aprobar">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-danger me-1" onclick="window.rechazarTestimonio(${testimonio.id})" title="Rechazar">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button class="btn btn-sm btn-info" onclick="window.verTestimonio(${testimonio.id})" title="Ver mensaje completo">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                        `;
                    }).join('');
                    console.log(`‚úÖ ${data.testimonios.length} testimonios cargados desde BD`);
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No se encontraron testimonios</td></tr>';
                }
            } catch (error) {
                console.error('‚ùå Error al cargar testimonios:', error);
                document.getElementById('tablaTestimonios').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error al cargar testimonios</td></tr>';
            }
        }

        async function cargarSoporte() {
            console.log('üîÑ Cargando tickets de soporte...');
            const tbody = document.getElementById('tablaSoporte');
            tbody.innerHTML = `
                <tr><td colspan="7" class="text-center">No hay tickets de soporte</td></tr>
            `;
        }

        // === FUNCIONES DE B√öSQUEDA ===
        function filtrarUsuarios() {
            const filtro = document.getElementById('searchUsuarios').value.toLowerCase();
            const filas = document.querySelectorAll('#tablaUsuarios tr');
            filas.forEach(fila => {
                const texto = fila.textContent.toLowerCase();
                fila.style.display = texto.includes(filtro) ? '' : 'none';
            });
        }

        function filtrarAfiliados() {
            const filtro = document.getElementById('searchAfiliados').value.toLowerCase();
            const filas = document.querySelectorAll('#tablaAfiliados tr');
            filas.forEach(fila => {
                const texto = fila.textContent.toLowerCase();
                fila.style.display = texto.includes(filtro) ? '' : 'none';
            });
        }

        function filtrarEscritores() {
            const filtro = document.getElementById('searchEscritores').value.toLowerCase();
            const filas = document.querySelectorAll('#tablaEscritores tr');
            filas.forEach(fila => {
                const texto = fila.textContent.toLowerCase();
                fila.style.display = texto.includes(filtro) ? '' : 'none';
            });
        }

        function filtrarLibros() {
            const filtro = document.getElementById('searchLibros').value.toLowerCase();
            const filas = document.querySelectorAll('#tablaLibros tr');
            filas.forEach(fila => {
                const texto = fila.textContent.toLowerCase();
                fila.style.display = texto.includes(filtro) ? '' : 'none';
            });
        }
        function filtrarCampanas() {
            const filtro = document.getElementById('searchCampanas').value.toLowerCase();
            const filas = document.querySelectorAll('#tablaCampanas tr');
            
            filas.forEach(fila => {
                const texto = fila.textContent.toLowerCase();
                fila.style.display = texto.includes(filtro) ? '' : 'none';
            });
        }

        function filtrarNotificaciones() {
            const filtro = document.getElementById('searchNotificaciones').value.toLowerCase();
            const filas = document.querySelectorAll('#tablaNotificaciones tr');
            
            filas.forEach(fila => {
                const texto = fila.textContent.toLowerCase();
                fila.style.display = texto.includes(filtro) ? '' : 'none';
            });
        }

        function filtrarArchivados() {
            const filtro = document.getElementById('searchArchivados').value.toLowerCase();
            const filas = document.querySelectorAll('#tablaArchivados tr');
            
            filas.forEach(fila => {
                const texto = fila.textContent.toLowerCase();
                fila.style.display = texto.includes(filtro) ? '' : 'none';
            });
        }

        // === FUNCIONES AUXILIARES ===
        function getPrioridadColor(prioridad) {
            switch(prioridad.toLowerCase()) {
                case 'alta': return '#dc3545';
                case 'media': return '#ffc107';
                case 'baja': return '#28a745';
                case 'critica': return '#fd7e14';
                default: return '#6c757d';
            }
        }

        // === FUNCIONES AUXILIARES ADICIONALES ===
        async function aprobarLibro(id) {
            const comentarios = prompt('Comentarios de aprobaci√≥n (opcional):') || '';
            
            if (confirm('¬øAprobar este libro para publicaci√≥n?')) {
                try {
                    const response = await fetch('api/admin/procesar_libro.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            libro_id: id,
                            accion: 'aprobar',
                            comentarios: comentarios
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        mostrarNotificacion('success', `‚úÖ ${data.message}`);
                        cargarRevision(); // Recargar la lista
                    } else {
                        mostrarNotificacion('error', `‚ùå Error: ${data.error}`);
                    }
                } catch (error) {
                    console.error('Error al aprobar libro:', error);
                    mostrarNotificacion('error', '‚ùå Error de conexi√≥n');
                }
            }
        }

        async function rechazarLibro(id) {
            const motivo = prompt('Motivo del rechazo (requerido):');
            
            if (motivo && motivo.trim()) {
                if (confirm('¬øRechazar este libro?')) {
                    try {
                        const response = await fetch('api/admin/procesar_libro.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                libro_id: id,
                                accion: 'rechazar',
                                comentarios: motivo
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            mostrarNotificacion('success', `‚úÖ ${data.message}`);
                            cargarRevision(); // Recargar la lista
                        } else {
                            mostrarNotificacion('error', `‚ùå Error: ${data.error}`);
                        }
                    } catch (error) {
                        console.error('Error al rechazar libro:', error);
                        mostrarNotificacion('error', '‚ùå Error de conexi√≥n');
                    }
                }
            } else if (motivo !== null) {
                alert('El motivo del rechazo es obligatorio');
            }
        }

        async function marcarEnRevision(id) {
            const comentarios = prompt('Comentarios de revisi√≥n (opcional):') || '';
            
            try {
                const response = await fetch('api/admin/procesar_libro.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        libro_id: id,
                        accion: 'revision',
                        comentarios: comentarios
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    mostrarNotificacion('success', `‚úÖ ${data.message}`);
                    cargarRevision(); // Recargar la lista
                } else {
                    mostrarNotificacion('error', `‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error al marcar en revisi√≥n:', error);
                mostrarNotificacion('error', '‚ùå Error de conexi√≥n');
            }
        }

        function mostrarNotificacion(tipo, mensaje) {
            // Crear elemento de notificaci√≥n
            const notificacion = document.createElement('div');
            notificacion.className = `alert alert-${tipo === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
            notificacion.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notificacion.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notificacion);
            
            // Auto-remover despu√©s de 5 segundos
            setTimeout(() => {
                if (notificacion.parentNode) {
                    notificacion.remove();
                }
            }, 5000);
        }

        function procesarPago(id) {
            if (confirm('¬øProcesar este pago?')) {
                alert(`Pago #${id} procesado correctamente`);
                cargarPagos();
            }
        }

        function responderTicket(id) {
            const respuesta = prompt('Escriba su respuesta:');
            if (respuesta) {
                alert(`Respuesta enviada al ticket #${id}`);
                cargarSoporte();
            }
        }

        // === INICIALIZACI√ìN ===
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ Panel de administraci√≥n cargado correctamente');
            
            // Agregar botones de prueba para debugging
            const debugDiv = document.createElement('div');
            debugDiv.style.cssText = 'position:fixed;top:10px;right:10px;z-index:9999;background:rgba(0,0,0,0.8);color:white;padding:10px;border-radius:5px;';
            debugDiv.innerHTML = `
                <h6>üîß Debug Panel</h6>
                <button onclick="window.duplicarCampana(1)" style="margin:2px;padding:5px;background:#007bff;color:white;border:none;border-radius:3px;">Test Duplicar</button><br>
                <button onclick="window.activarCampana(2)" style="margin:2px;padding:5px;background:#28a745;color:white;border:none;border-radius:3px;">Test Activar</button><br>
                <button onclick="window.eliminarCampana(3)" style="margin:2px;padding:5px;background:#dc3545;color:white;border:none;border-radius:3px;">Test Eliminar</button><br>
                <button onclick="this.parentNode.remove()" style="margin:2px;padding:5px;background:#6c757d;color:white;border:none;border-radius:3px;">Cerrar</button>
            `;
            document.body.appendChild(debugDiv);
            
            // Verificar que todas las funciones est√©n disponibles
            const functions = [
                'verCampana', 'duplicarCampana', 'activarCampana', 'eliminarCampana',
                'verNotificacion', 'marcarLeida', 'eliminarNotificacion',
                'verUsuario', 'editarUsuario', 'toggleEstadoUsuario', 'eliminarUsuario',
                'verAfiliado', 'toggleEstadoAfiliado', 'eliminarAfiliado',
                'verEscritor', 'toggleEstadoEscritor', 'eliminarEscritor',
                'verLibro', 'toggleEstadoLibro', 'eliminarLibro',
                'verTestimonio', 'aprobarTestimonio', 'rechazarTestimonio'
            ];
            
            console.log('üîß Verificando funciones:');
            functions.forEach(func => {
                const exists = typeof window[func] === 'function';
                console.log(`${exists ? '‚úÖ' : '‚ùå'} window.${func}: ${typeof window[func]}`);
            });
            
            // Cargar estad√≠sticas din√°micas del Resumen General
            cargarDashboardCompleto();
        });
        
        // === FUNCI√ìN PARA CARGAR ESTAD√çSTICAS DIN√ÅMICAS ===
        async function cargarEstadisticasDashboard() {
            console.log('üìä Cargando estad√≠sticas del Resumen General...');
            
            try {
                const response = await fetch('api/dashboard/estadisticas.php');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.estadisticas;
                    
                    // Actualizar las 4 tarjetas principales
                    document.getElementById('total-usuarios').textContent = stats.usuarios_total;
                    document.getElementById('total-libros').textContent = stats.libros_publicados;
                    document.getElementById('total-campanas').textContent = stats.campanas_activas;
                    document.getElementById('total-ventas').textContent = stats.ingresos_mes_formato;
                    
                    console.log('‚úÖ Estad√≠sticas actualizadas:', {
                        usuarios: stats.usuarios_total,
                        libros: stats.libros_publicados,
                        campa√±as: stats.campanas_activas,
                        ventas: stats.ingresos_mes_formato
                    });
                    
                    // Opcional: Actualizar metadatos (√∫ltima actualizaci√≥n)
                    const lastUpdate = document.createElement('small');
                    lastUpdate.className = 'text-muted d-block mt-2';
                    lastUpdate.textContent = `Actualizado: ${new Date(stats.fecha_actualizacion).toLocaleString()}`;
                    
                    // Agregar indicador de √∫ltima actualizaci√≥n al primer card
                    const firstCard = document.querySelector('.stats-card');
                    if (firstCard && !firstCard.querySelector('.last-update')) {
                        lastUpdate.classList.add('last-update');
                        firstCard.appendChild(lastUpdate);
                    }
                    
                } else {
                    console.error('‚ùå Error cargando estad√≠sticas:', data.error);
                    // En caso de error, mantener valores por defecto pero avisar
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'alert alert-warning alert-dismissible fade show';
                    errorMsg.innerHTML = `
                        <strong>‚ö†Ô∏è Advertencia:</strong> No se pudieron cargar las estad√≠sticas en tiempo real. 
                        Mostrando datos de respaldo.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.querySelector('#dashboard .row').insertBefore(errorMsg, document.querySelector('#dashboard .row').firstChild);
                }
                
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n cargando estad√≠sticas:', error);
                
                // Mantener valores hardcodeados como respaldo
                console.log('üîÑ Usando valores de respaldo');
                
                // Mostrar aviso discreto de que no hay conexi√≥n en tiempo real
                const connectionMsg = document.createElement('small');
                connectionMsg.className = 'text-warning d-block mt-1';
                connectionMsg.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Sin conexi√≥n en tiempo real';
                
                const firstCard = document.querySelector('.stats-card');
                if (firstCard && !firstCard.querySelector('.connection-warning')) {
                    connectionMsg.classList.add('connection-warning');
                    firstCard.appendChild(connectionMsg);
                }
            }
        }
        
        // === FUNCI√ìN PARA REFRESCAR ESTAD√çSTICAS ===
        function refrescarEstadisticas() {
            console.log('üîÑ Refrescando estad√≠sticas...');
            
            // Limpiar indicadores previos
            document.querySelectorAll('.last-update, .connection-warning').forEach(el => el.remove());
            document.querySelectorAll('.alert-warning').forEach(el => el.remove());
            
            // Recargar
            cargarEstadisticasDashboard();
        }
        
        // === FUNCI√ìN PARA CARGAR RANKINGS Y TOP PERFORMERS ===
        async function cargarRankings() {
            console.log('üèÜ Cargando rankings...');
            
            try {
                const response = await fetch('api/dashboard/rankings.php');
                const data = await response.json();
                
                if (data.success) {
                    const rankings = data.rankings;
                    const content = document.getElementById('rankings-content');
                    
                    content.innerHTML = `
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="stats-card" style="border-left-color: #28a745;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-1">Escritor del Mes</h6>
                                        <h5 class="mb-0 text-success">${rankings.escritor_del_mes.nombre}</h5>
                                        <small class="text-muted">${rankings.escritor_del_mes.libros_publicados} libros</small>
                                    </div>
                                    <div class="text-end">
                                        <i class="fas fa-user-edit fa-2x text-success opacity-50"></i>
                                    </div>
                                </div>
                                <hr class="my-2">
                                <small class="text-muted">
                                    <i class="fas fa-dollar-sign"></i> ${rankings.escritor_del_mes.royalties_formato}
                                </small>
                            </div>
                        </div>
                        
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="stats-card" style="border-left-color: #ffc107;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-1">Afiliado Destacado</h6>
                                        <h5 class="mb-0 text-warning">${rankings.afiliado_destacado.nombre}</h5>
                                        <small class="text-muted">${rankings.afiliado_destacado.ventas_referidas} ventas</small>
                                    </div>
                                    <div class="text-end">
                                        <i class="fas fa-handshake fa-2x text-warning opacity-50"></i>
                                    </div>
                                </div>
                                <hr class="my-2">
                                <small class="text-muted">
                                    <i class="fas fa-dollar-sign"></i> ${rankings.afiliado_destacado.comisiones_formato}
                                </small>
                            </div>
                        </div>
                        
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="stats-card" style="border-left-color: #007bff;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-1">Libro Destacado</h6>
                                        <h5 class="mb-0 text-primary">${rankings.libro_mas_vendido.titulo}</h5>
                                        <small class="text-muted">${rankings.libro_mas_vendido.total_ventas} ventas</small>
                                    </div>
                                    <div class="text-end">
                                        <i class="fas fa-book fa-2x text-primary opacity-50"></i>
                                    </div>
                                </div>
                                <hr class="my-2">
                                <small class="text-muted">
                                    <i class="fas fa-user"></i> ${rankings.libro_mas_vendido.autor}
                                </small>
                            </div>
                        </div>
                        
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="stats-card" style="border-left-color: #6f42c1;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-1">Categor√≠a Popular</h6>
                                        <h5 class="mb-0 text-info">${rankings.categoria_popular.nombre}</h5>
                                        <small class="text-muted">${rankings.categoria_popular.total_libros} libros</small>
                                    </div>
                                    <div class="text-end">
                                        <i class="fas fa-tags fa-2x text-info opacity-50"></i>
                                    </div>
                                </div>
                                <hr class="my-2">
                                <small class="text-muted">
                                    <i class="fas fa-chart-line"></i> Per√≠odo: ${data.periodo.mes_nombre}
                                </small>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('rankings-content').innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i> Error cargando rankings: ${data.error}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Error cargando rankings:', error);
                document.getElementById('rankings-content').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> Error de conexi√≥n
                    </div>
                `;
            }
        }
        
        // === FUNCI√ìN PARA CARGAR ALERTAS DEL SISTEMA ===
        async function cargarAlertas() {
            console.log('‚ö†Ô∏è Cargando alertas...');
            
            try {
                const response = await fetch('api/dashboard/alertas_gestion.php');
                const data = await response.json();
                
                if (data.success) {
                    const alertas = data.alertas;
                    const content = document.getElementById('alertas-content');
                    
                    if (alertas.length === 0) {
                        content.innerHTML = `
                            <div class="text-center py-3">
                                <i class="fas fa-check-circle text-success fa-2x"></i>
                                <p class="mb-0 mt-2">No hay alertas pendientes</p>
                            </div>
                        `;
                    } else {
                        let alertasHtml = '';
                        alertas.forEach(alerta => {
                            const colorClass = alerta.nivel === 'critica' ? 'danger' : 
                                             alerta.nivel === 'alta' ? 'warning' : 
                                             alerta.nivel === 'media' ? 'info' : 
                                             alerta.nivel === 'success' ? 'success' : 'secondary';
                            
                            const iconColor = alerta.nivel === 'critica' ? 'text-danger' : 
                                            alerta.nivel === 'alta' ? 'text-warning' : 
                                            alerta.nivel === 'media' ? 'text-info' : 
                                            alerta.nivel === 'success' ? 'text-success' : 'text-muted';
                            
                            alertasHtml += `
                                <div class="alerta-item" style="border-left: 3px solid var(--bs-${colorClass});">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="${alerta.icono} ${iconColor} fa-lg"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1 fw-bold">${alerta.titulo}</h6>
                                            <p class="mb-1 text-muted small">${alerta.descripcion}</p>
                                            ${alerta.detalle ? `<small class="text-muted">${alerta.detalle}</small>` : ''}
                                        </div>
                                        <div class="text-end">
                                            ${alerta.cantidad > 0 ? `<span class="badge-custom bg-${colorClass} text-white mb-1">${alerta.cantidad}</span><br>` : ''}
                                            ${alerta.accion ? `<a href="#" class="btn btn-sm btn-outline-${colorClass}" onclick="alert('Funcionalidad: ${alerta.enlace}')">${alerta.accion}</a>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        content.innerHTML = alertasHtml;
                    }
                    
                    // Actualizar contador en el header si es necesario
                    const resumen = data.resumen;
                    if (resumen.criticas > 0 || resumen.altas > 0) {
                        console.log(`‚ö†Ô∏è ${resumen.criticas} alertas cr√≠ticas, ${resumen.altas} alertas altas`);
                    }
                    
                } else {
                    document.getElementById('alertas-content').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Error cargando alertas: ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Error cargando alertas:', error);
                document.getElementById('alertas-content').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> Error de conexi√≥n
                    </div>
                `;
            }
        }
        
        // === FUNCI√ìN PARA CARGAR ACTIVIDAD RECIENTE ===
        async function cargarActividad() {
            console.log('üìù Cargando actividad reciente...');
            
            try {
                const response = await fetch('api/dashboard/actividad.php?limite=8');
                const data = await response.json();
                
                if (data.success) {
                    const actividades = data.actividades;
                    const content = document.getElementById('actividad-content');
                    
                    if (actividades.length === 0) {
                        content.innerHTML = `
                            <div class="text-center py-4">
                                <i class="fas fa-history text-muted fa-2x"></i>
                                <p class="mb-0 mt-2 text-muted">No hay actividad reciente</p>
                            </div>
                        `;
                    } else {
                        let actividadHtml = '';
                        actividades.forEach((actividad, index) => {
                            actividadHtml += `
                                <div class="actividad-item">
                                    <div class="d-flex align-items-start">
                                        <div class="flex-shrink-0 me-3">
                                            <div class="bg-light rounded-circle p-2" style="width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;">
                                                <i class="${actividad.icono} ${actividad.color} fa-lg"></i>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1 fw-bold">${actividad.titulo}</h6>
                                            <p class="mb-1 text-muted">${actividad.descripcion}</p>
                                            <small class="text-muted">${actividad.detalle}</small>
                                            <div class="mt-2">
                                                <span class="badge-custom bg-secondary text-white">${actividad.fecha_humana}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        content.innerHTML = actividadHtml;
                    }
                } else {
                    document.getElementById('actividad-content').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Error cargando actividad: ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Error cargando actividad:', error);
                document.getElementById('actividad-content').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> Error de conexi√≥n
                    </div>
                `;
            }
        }
        
        // === FUNCI√ìN PARA REFRESCAR ACTIVIDAD ===
        function refrescarActividad() {
            console.log('üîÑ Refrescando actividad...');
            document.getElementById('actividad-content').innerHTML = `
                <div class="text-center py-3">
                    <i class="fas fa-spinner fa-spin"></i> Actualizando...
                </div>
            `;
            cargarActividad();
        }
        
        // === FUNCIONES UTILITARIAS PARA MODALES ===
        function crearModal(titulo, contenido, icono = 'fas fa-info-circle') {
            // Cerrar modal existente si hay uno
            const modalExistente = document.querySelector('.modal-overlay');
            if (modalExistente) {
                modalExistente.remove();
            }
            
            const modalHTML = `
                <div class="modal-overlay" onclick="cerrarModal(event)">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="${icono}"></i> ${titulo}
                            </h5>
                            <button class="modal-close" onclick="cerrarModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            ${contenido}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function cerrarModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => modal.remove(), 300);
            }
        }
        
        function formatearFecha(fecha) {
            if (!fecha) return 'No disponible';
            return new Date(fecha).toLocaleString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function obtenerBadgeEstado(estado) {
            const estados = {
                'activo': 'badge-activo',
                'inactivo': 'badge-inactivo', 
                'pendiente': 'badge-pendiente'
            };
            return estados[estado.toLowerCase()] || 'badge-pendiente';
        }
        
        // === FUNCI√ìN PARA CARGAR TODO EL RESUMEN GENERAL MEJORADO ===
        function cargarDashboardCompleto() {
            console.log('üéØ Cargando Resumen General completo...');
            
            // Cargar estad√≠sticas principales
            cargarEstadisticasDashboard();
            
            // Cargar widgets adicionales
            cargarRankings();
            cargarAlertas();
            cargarActividad();
            
            console.log('‚úÖ Resumen General completo iniciado');
        }
    </script>
    
    <!-- Modal Crear/Editar Campa√±a -->
    <div id="modalCampana" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:1000;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:2rem 2.5rem;border-radius:12px;min-width:320px;max-width:95vw;max-height:90vh;box-shadow:0 4px 24px rgba(0,0,0,0.12);position:relative;overflow-y:auto;">
            <button id="cerrarModalCampana" style="position:absolute;top:1rem;right:1rem;background:none;border:none;font-size:1.5rem;color:#888;cursor:pointer;z-index:10;">&times;</button>
            <h2 id="modalCampanaTitulo" style="margin-top:0;margin-bottom:1.5rem;padding-right:2rem;">Crear Campa√±a</h2>
            <form id="formCampana">
                <div style="margin-bottom:1rem;">
                    <label>Nombre:<br><input type="text" name="nombre" required style="width:100%;padding:0.5rem;border:1px solid #ccc;border-radius:4px;"></label>
                </div>
                <div style="margin-bottom:1rem;">
                    <label>Descripci√≥n:<br><textarea name="descripcion" required style="width:100%;padding:0.5rem;height:100px;border:1px solid #ccc;border-radius:4px;"></textarea></label>
                </div>
                <div style="margin-bottom:1rem;">
                    <label>Imagen Promocional:<br>
                        <input type="file" name="imagen_promocional" accept="image/*" style="width:100%;padding:0.5rem;border:1px solid #ccc;border-radius:4px;">
                        <small style="color:#666;">Formatos: JPG, PNG, GIF (m√°ximo 2MB)</small>
                        <div id="previewImagenCampana" style="margin-top:0.5rem;display:none;">
                            <img id="previewImgCampana" src="" alt="Vista previa" style="max-width:200px;max-height:150px;border-radius:4px;">
                            <button type="button" id="eliminarImagenCampana" style="display:block;margin-top:0.5rem;background:#dc3545;color:white;border:none;padding:0.25rem 0.5rem;border-radius:4px;cursor:pointer;">Eliminar imagen</button>
                        </div>
                    </label>
                </div>
                <div style="margin-bottom:1rem;">
                    <label>Libro(s) a Promocionar:<br>
                        <select name="libro_ids[]" multiple style="width:100%;padding:0.5rem;border:1px solid #ccc;border-radius:4px;height:120px;" id="selectLibrosCampana">
                            <!-- Se cargan din√°micamente -->
                        </select>
                        <small style="color:#666;">Mant√©n Ctrl presionado para seleccionar m√∫ltiples libros</small>
                    </label>
                </div>
                <div style="margin-bottom:1rem;">
                    <label>Tipo:<br>
                        <select name="tipo" required style="width:100%;padding:0.5rem;border:1px solid #ccc;border-radius:4px;">
                            <option value="email">Email</option>
                            <option value="promocion">Promoci√≥n</option>
                            <option value="afiliados">Afiliados</option>
                            <option value="sistema">Sistema</option>
                        </select>
                    </label>
                </div>
                <div style="margin-bottom:1rem;">
                    <label>Audiencia Tipo:<br>
                        <select name="audiencia_tipo" required style="width:100%;padding:0.5rem;border:1px solid #ccc;border-radius:4px;">
                            <option value="todos">Todos</option>
                            <option value="afiliados">Afiliados</option>
                            <option value="escritores">Escritores</option>
                            <option value="lectores">Lectores</option>
                            <option value="personalizada">Personalizada</option>
                        </select>
                    </label>
                </div>
                <div style="margin-bottom:1rem;">
                    <label>Fecha Programada (opcional):<br><input type="datetime-local" name="fecha_programada" style="width:100%;padding:0.5rem;border:1px solid #ccc;border-radius:4px;"></label>
                </div>
                <div style="margin-bottom:1rem;">
                    <label>Estado:<br>
                        <select name="estado" required style="width:100%;padding:0.5rem;border:1px solid #ccc;border-radius:4px;">
                            <option value="borrador">Borrador</option>
                            <option value="programada">Programada</option>
                            <option value="enviando">Enviando</option>
                            <option value="completada">Completada</option>
                            <option value="pausada">Pausada</option>
                            <option value="cancelada">Cancelada</option>
                        </select>
                    </label>
                </div>
                <div style="text-align:right;display:flex;gap:0.5rem;justify-content:flex-end;">
                    <button type="submit" class="btn btn-success">Guardar</button>
                    <button type="button" id="btnCompartirRed" class="btn" style="background:#6366f1;color:white;" disabled>üì¢ Compartir con Red</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Funciones del modal de campa√±as
        const modalCampana = document.getElementById('modalCampana');
        const formCampana = document.getElementById('formCampana');
        const cerrarModalCampana = document.getElementById('cerrarModalCampana');
        
        // Funci√≥n para cargar libros en el select
        async function cargarLibrosEnSelect() {
            try {
                const res = await fetch('api/libros/disponibles.php');
                const data = await res.json();
                
                if (data.success) {
                    const select = document.getElementById('selectLibrosCampana');
                    select.innerHTML = '<option value="">-- Sin libro espec√≠fico --</option>';
                    
                    data.libros.forEach(libro => {
                        const option = document.createElement('option');
                        option.value = libro.id;
                        option.textContent = `${libro.titulo} - ${libro.autor_nombre}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error cargando libros:', error);
            }
        }
        
        // Cerrar modal
        cerrarModalCampana.addEventListener('click', function() {
            modalCampana.style.display = 'none';
        });
        
        // Cerrar modal al hacer clic fuera
        window.addEventListener('click', function(e) {
            if (e.target === modalCampana) modalCampana.style.display = 'none';
        });
        
        // Manejar vista previa de imagen
        document.querySelector('input[name="imagen_promocional"]').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Validar tipo de archivo
            if (!file.type.startsWith('image/')) {
                alert('Por favor selecciona un archivo de imagen v√°lido');
                this.value = '';
                return;
            }

            // Validar tama√±o (2MB m√°ximo)
            if (file.size > 2 * 1024 * 1024) {
                alert('La imagen debe ser menor a 2MB');
                this.value = '';
                return;
            }

            // Mostrar vista previa
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewContainer = document.getElementById('previewImagenCampana');
                const previewImg = document.getElementById('previewImgCampana');
                
                previewImg.src = e.target.result;
                previewContainer.style.display = 'block';
            };
            reader.readAsDataURL(file);
        });
        
        // Manejar eliminaci√≥n de imagen
        document.getElementById('eliminarImagenCampana').addEventListener('click', function() {
            document.querySelector('input[name="imagen_promocional"]').value = '';
            document.getElementById('previewImagenCampana').style.display = 'none';
        });
        
        // Enviar formulario de campa√±a (crear)
        formCampana.onsubmit = async function(e) {
            e.preventDefault();
            
            console.log('üöÄ Iniciando env√≠o de formulario de campa√±a...');
            
            // Usar FormData para manejar archivos
            const formData = new FormData(formCampana);
            
            // Debug: mostrar todos los datos del formulario
            console.log('üìã Datos del formulario:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: ${value}`);
            }
            
            try {
                console.log('üì° Enviando petici√≥n a api/campanas/crear.php...');
                const res = await fetch('api/campanas/crear.php', {
                    method: 'POST',
                    body: formData // No usar headers con FormData
                });
                
                console.log('üì® Respuesta recibida:', res.status, res.statusText);
                
                const data = await res.json();
                console.log('üìÑ Datos de respuesta:', data);
                
                if (data.success) {
                    alert('Campa√±a creada correctamente');
                    
                    // Habilitar bot√≥n de compartir si se cre√≥ exitosamente
                    if (data.campana && data.campana.id) {
                        console.log('‚úÖ Habilitando bot√≥n de compartir para campa√±a ID:', data.campana.id);
                        const btnCompartir = document.getElementById('btnCompartirRed');
                        btnCompartir.disabled = false;
                        btnCompartir.onclick = () => compartirConRed(data.campana.id);
                    }
                    
                    modalCampana.style.display = 'none';
                    // Recargar campa√±as si existe la funci√≥n
                    if (typeof cargarCampanas === 'function') {
                        cargarCampanas();
                    }
                } else {
                    console.error('‚ùå Error en la respuesta:', data.error);
                    alert('Error: ' + (data.error || 'No se pudo crear la campa√±a'));
                }
            } catch (err) {
                console.error('‚ùå Error creando campa√±a:', err);
                alert('Error de conexi√≥n: ' + err.message);
            }
        };
        
        // Funci√≥n para compartir campa√±a con la red
        async function compartirConRed(campanaId) {
            console.log('üåê Iniciando compartir con red, campa√±a ID:', campanaId);
            
            if (!confirm('¬øEst√°s seguro de que quieres compartir esta campa√±a con toda la red de afiliados?')) {
                console.log('‚ùå Usuario cancel√≥ el compartir');
                return;
            }
            
            try {
                console.log('üì° Enviando petici√≥n a api/campanas/compartir_red.php...');
                const res = await fetch('api/campanas/compartir_red.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ campana_id: campanaId })
                });
                
                console.log('üì® Respuesta recibida:', res.status, res.statusText);
                
                const data = await res.json();
                console.log('üìÑ Datos de respuesta compartir:', data);
                
                if (data.success) {
                    alert(`Campa√±a compartida exitosamente con ${data.afiliados_notificados || 0} afiliados`);
                } else {
                    console.error('‚ùå Error al compartir:', data.error);
                    alert('Error: ' + (data.error || 'No se pudo compartir la campa√±a'));
                }
            } catch (error) {
                console.error('‚ùå Error compartiendo campa√±a:', error);
                alert('Error de conexi√≥n al compartir la campa√±a: ' + error.message);
            }
        }
    </script>
    </div> <!-- Closing div for admin-panel-content -->
</body>
</html>